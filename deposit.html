<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AmeerTech NIN Generator â€” Deposit</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body{font-family:Arial, sans-serif;background:#f8fafc;margin:0;padding:0;color:#1e293b}
    header{background:#0ea5a0;color:white;padding:16px;font-size:20px;font-weight:700;display:flex;justify-content:space-between;align-items:center}
    .container{max-width:700px;margin:20px auto;padding:20px}
    .card{background:white;border-radius:12px;padding:16px;margin-bottom:16px;box-shadow:0 2px 10px rgba(0,0,0,0.08)}
    .btn{padding:10px 14px;border:none;border-radius:6px;font-weight:600;cursor:pointer}
    .btn-main{background:#0ea5a0;color:white}
    .btn-back{background:#475569;color:white}
    input,select{padding:10px;width:100%;margin-bottom:12px;border:1px solid #cbd5e1;border-radius:6px}
    .hidden{display:none}
    .center{text-align:center}
    .circle{ width:110px;height:110px;border-radius:50%; background:conic-gradient(#f59e0b 0% 75%, #fde68a 75% 100%); display:flex;align-items:center;justify-content:center; margin:0 auto 10px; }
    .icon-big{font-size:60px;}
    .success{color:#16a34a}
    .decline{color:#dc2626}
    .processing{color:#92400e}
    .history-list{margin-top:12px; max-height:320px; overflow:auto; border-radius:8px; padding:8px; background:#fbfdfe; border:1px solid #e6eef0}
    .tx-item{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-bottom:1px solid #eef3f5}
    .tx-left{display:flex;flex-direction:column;gap:4px}
    .tx-amount{font-weight:800}
    .tx-date{font-size:12px;color:#6b7280}
    .empty-note{padding:12px;text-align:center;color:#64748b;font-weight:600}
    .status-badge{display:inline-block;padding:4px 8px;border-radius:10px;font-weight:700;font-size:11px;margin-left:8px;background:rgba(0,0,0,0.04)}
    .tx-note{font-size:13px;color:#334155}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;background:rgba(0,0,0,0.8);color:#fff;padding:10px 18px;border-radius:20px;opacity:0;pointer-events:none;transition:0.35s}
    .toast.show{opacity:1;bottom:40px;pointer-events:auto}
  </style>
</head>
<body>
<header>
  <div>AmeerTech Deposit</div>
  <div><button class="btn btn-back" onclick="window.location.href='dashboard.html'">Back</button></div>
</header>

<div class="container">
  <div id="currentBox" class="card hidden" aria-live="polite">
    <h2>Current Transaction</h2>
    <div id="currentContent" class="center"></div>
  </div>

  <div id="depositForm" class="card">
    <h2>Add Fund</h2>
    <p style="color:red;font-weight:600">âš  Minimum deposit â‚¦210 (â‚¦200 per generate NIN)</p>

    <div id="step1">
      <label>Amount (â‚¦)</label>
      <input type="number" id="depAmount" placeholder="Enter amount" min="210" value="210" required>
      <div style="margin-top:10px">
        <button id="payCardBtn" class="btn btn-main">ðŸ’³ Pay with Card</button>
      </div>
    </div>
  </div>

  <div id="historyCard" class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
      <div>
        <h2 style="margin:0">History</h2>
        <div style="font-size:13px;color:#475569;margin-top:6px">Recent deposits (only)</div>
      </div>
      <div>
        <button class="btn" id="refreshHistoryBtn">Refresh</button>
      </div>
    </div>
    <div id="historyContent" class="history-list" style="margin-top:12px">
      <div id="historyLoader" class="empty-note">Loading depositsâ€¦</div>
      <div id="historyList" style="display:none"></div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, onValue, get, child } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  // <<-- Put your Firebase config here (same as before) -->
  const firebaseConfig = {
    apiKey: "AIzaSyDc0bIipHU7N73mju33dNwSWmH3IeIYkog",
    authDomain: "ameernin-ba310.firebaseapp.com",
    databaseURL: "https://ameernin-ba310-default-rtdb.firebaseio.com",
    projectId: "ameernin-ba310",
    storageBucket: "ameernin-ba310.appspot.com",
    messagingSenderId: "522206845073",
    appId: "1:522206845073:web:3c85714bd7eda6c1048730"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);

  // UI refs
  const payCardBtn = document.getElementById('payCardBtn');
  const depAmountInput = document.getElementById('depAmount');
  const historyLoader = document.getElementById('historyLoader');
  const historyListEl = document.getElementById('historyList');
  const currentBox = document.getElementById('currentBox');
  const currentContent = document.getElementById('currentContent');
  const toastEl = document.getElementById('toast');
  const refreshBtn = document.getElementById('refreshHistoryBtn');

  function showToast(msg, t = 3000){
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    setTimeout(()=> toastEl.classList.remove('show'), t);
  }

  function loadPaystackScript(){
    return new Promise((resolve, reject) => {
      if(window.PaystackPop) return resolve(window.PaystackPop);
      const s = document.createElement('script');
      s.src = 'https://js.paystack.co/v1/inline.js';
      s.onload = () => resolve(window.PaystackPop);
      s.onerror = () => reject(new Error('Failed to load Paystack script'));
      document.head.appendChild(s);
    });
  }

  // IMPORTANT: replace with your test public key (or keep and change to pk_live_... when ready)
  const PAYSTACK_PUBLIC_KEY = "pk_test_6351d09de2b28b62e4e8e4869c0eb45a1e3dca11";

  let uid = null;
  onAuthStateChanged(auth, (user) => {
    if(user){
      uid = user.uid;
      localStorage.setItem('currentUserId', uid);
      const userDepositsRef = ref(db, `deposits/${uid}`);
      onValue(userDepositsRef, (snap) => renderDepositsSnap(snap));
    } else {
      const stored = localStorage.getItem('currentUserId');
      if(stored) uid = stored;
      else { uid = null; /* redirect if you want */ }
    }
  });

  payCardBtn.addEventListener('click', async (e) => {
    e.preventDefault();
    if(!uid){ showToast('You must be logged in to deposit.'); return; }
    const amount = Number(depAmountInput.value || 0);
    if(!amount || amount < 210){ showToast('Minimum deposit â‚¦210'); return; }

    payCardBtn.disabled = true; payCardBtn.textContent = 'Opening payment...';
    try {
      const email = (auth.currentUser && auth.currentUser.email) || '';
      const res = await fetch('/.netlify/functions/init-pay', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ uid, email, amount })
      });

      // safe parse: if not JSON, read text for debugging
      let init;
      try { init = await res.json(); } catch(e) {
        const txt = await res.text();
        console.error('init-pay non-json response:', txt);
        showToast('Failed to start payment. Try again.');
        payCardBtn.disabled = false; payCardBtn.textContent = 'ðŸ’³ Pay with Card';
        return;
      }

      if(!res.ok || !init || !init.data || !init.data.reference){
        console.error('init-pay failed', init);
        showToast('Failed to start payment. Try again.');
        payCardBtn.disabled = false; payCardBtn.textContent = 'ðŸ’³ Pay with Card';
        return;
      }

      const reference = init.data.reference;
      const amountKobo = Math.round(amount * 100);
      await loadPaystackScript();

      const handler = PaystackPop.setup({
        key: PAYSTACK_PUBLIC_KEY,
        email,
        amount: amountKobo,
        ref: reference,
        currency: "NGN",
        callback: function(response){
          // popup succeeded â€” webhook or verify function will confirm and update DB
          showToast('Payment submitted. Waiting for confirmation...');
          payCardBtn.disabled = false; payCardBtn.textContent = 'ðŸ’³ Pay with Card';
        },
        onClose: function(){
          showToast('Payment window closed');
          payCardBtn.disabled = false; payCardBtn.textContent = 'ðŸ’³ Pay with Card';
        }
      });
      handler.openIframe();

    } catch(err){
      console.error('startPay error', err);
      showToast('Error initiating payment');
      payCardBtn.disabled = false; payCardBtn.textContent = 'ðŸ’³ Pay with Card';
    }
  });

  async function loadDeposits(){
    if(!uid){ historyLoader.textContent = 'Not signed in.'; return; }
    historyLoader.style.display = 'block'; historyListEl.style.display = 'none'; historyListEl.innerHTML = '';
    try{
      const snap = await get(child(ref(db), `deposits/${uid}`));
      renderDepositsSnap(snap);
    }catch(e){
      console.error('loadDeposits failed', e);
      historyLoader.textContent = 'Failed to load deposits.';
    }
  }

  function renderDepositsSnap(snap){
    historyListEl.innerHTML = '';
    if(!snap || !snap.exists()){
      historyLoader.textContent = 'No deposits yet.'; currentBox.classList.add('hidden'); historyListEl.style.display='none'; return;
    }
    const arr = [];
    snap.forEach(ch=> arr.push({ id: ch.key, ...ch.val() }));
    arr.sort((a,b)=> (b.updatedAt || b.timestamp || 0) - (a.updatedAt || a.timestamp || 0));
    const latest = arr[0];
    renderCurrent(latest, arr);
    arr.slice(0,20).forEach(d=>{
      const item = document.createElement('div'); item.className='tx-item';
      const left = document.createElement('div'); left.className='tx-left';
      const title = document.createElement('div');
      const typeSpan = document.createElement('span'); typeSpan.className='tx-type credit'; typeSpan.textContent='DEPOSIT ';
      const amtSpan = document.createElement('span'); amtSpan.className='tx-amount'; amtSpan.textContent = 'â‚¦' + Number(d.amount||0).toLocaleString();
      title.appendChild(typeSpan); title.appendChild(amtSpan);
      if(d.status){ const sb = document.createElement('span'); sb.className='status-badge '+d.status; sb.textContent = (d.status||'').toUpperCase(); title.appendChild(sb); }
      const note = document.createElement('div'); note.className='tx-note';
      note.textContent = d.reference ? `Ref: ${d.reference}` : (d.accountNo ? `From: ${d.accountNo} (${d.bank||''})` : (d.note||'Deposit record'));
      left.appendChild(title); left.appendChild(note);
      const right = document.createElement('div'); right.className='tx-date';
      const ts = d.updatedAt || d.timestamp || Date.now();
      right.textContent = new Date(Number(ts)).toLocaleString();
      item.appendChild(left); item.appendChild(right); historyListEl.appendChild(item);
    });
    historyLoader.style.display='none'; historyListEl.style.display='block';
  }

  function renderCurrent(latest){
    if(!latest){ currentBox.classList.add('hidden'); return; }
    currentBox.classList.remove('hidden');
    const s = (latest.status||'').toString().toLowerCase();
    if(['submitted','initiated','processing'].includes(s)) document.getElementById('depositForm').classList.add('hidden'); else document.getElementById('depositForm').classList.remove('hidden');
    if(s==='initiated' || s==='processing'){
      currentContent.innerHTML = `<div class="circle"><i class="fa fa-clock icon-big processing"></i></div><p>Transaction processing â‚¦${latest.amount}...</p><small>${latest.date||''} ${latest.timeTxt||''}</small>`;
    } else if(s==='approved'){
      currentContent.innerHTML = `<div><i class="fa fa-check-circle icon-big success"></i></div><p>Your transaction of â‚¦${latest.amount} was successful.</p><small>${latest.date||''} ${latest.timeTxt||''}</small>`;
    } else if(s==='declined'){
      currentContent.innerHTML = `<div><i class="fa fa-times-circle icon-big decline"></i></div><p>Your transaction of â‚¦${latest.amount} was declined.</p><small>${latest.date||''} ${latest.timeTxt||''}</small>`;
    } else {
      currentContent.innerHTML = `<div><i class="fa fa-info-circle icon-big"></i></div><p>Last deposit: â‚¦${latest.amount} â€” ${latest.status || 'â€”'}</p><small>${latest.date||''} ${latest.timeTxt||''}</small>`;
    }
  }

  document.getElementById('refreshHistoryBtn').addEventListener('click', loadDeposits);

  // try initial load from local storage if auth not finished
  setTimeout(()=> {
    const stored = localStorage.getItem('currentUserId');
    if(stored){ uid = stored; loadDeposits(); }
  }, 800);
</script>
</body>
</html>
