<!DOCTYPE html><html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AmeerTech NIN Generator — Deposit</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body{font-family:Arial, sans-serif;background:#f8fafc;margin:0;padding:0;color:#1e293b}
    header{background:#0ea5a0;color:white;padding:16px;font-size:20px;font-weight:700;display:flex;justify-content:space-between;align-items:center}
    .container{max-width:700px;margin:20px auto;padding:20px}
    .card{background:white;border-radius:12px;padding:16px;margin-bottom:16px;box-shadow:0 2px 10px rgba(0,0,0,0.08)}
    .btn{padding:10px 14px;border:none;border-radius:6px;font-weight:600;cursor:pointer}
    .btn-main{background:#0ea5a0;color:white}
    .btn-back{background:#475569;color:white}
    input,select{padding:10px;width:100%;margin-bottom:12px;border:1px solid #cbd5e1;border-radius:6px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    td,th{border-bottom:1px solid #e2e8f0;padding:8px;text-align:left}
    .hidden{display:none}
    .center{text-align:center}
    .circle{ width:110px;height:110px;border-radius:50%; background:conic-gradient(#f59e0b 0% 75%, #fde68a 75% 100%); display:flex;align-items:center;justify-content:center; margin:0 auto 10px; }
    .icon-big{font-size:60px;}
    .success{color:#16a34a}
    .decline{color:#dc2626}
    .cancel{color:#6b7280}
    .processing{color:#92400e}
    .history-list{margin-top:12px; max-height:320px; overflow:auto; border-radius:8px; padding:8px; background:#fbfdfe; border:1px solid #e6eef0}
    .tx-item{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;border-bottom:1px solid #eef3f5}
    .tx-item:last-child{border-bottom:none}
    .tx-left{display:flex;flex-direction:column;gap:4px}
    .tx-type.credit{color:#047857;font-weight:800}
    .tx-type.debit{color:#9b1c1c;font-weight:800}
    .tx-amount{font-weight:800}
    .tx-date{font-size:12px;color:#6b7280}
    .empty-note{padding:12px;text-align:center;color:#64748b;font-weight:600}
    .status-badge{display:inline-block;padding:4px 8px;border-radius:10px;font-weight:700;font-size:11px;margin-left:8px;background:rgba(0,0,0,0.04)}
    .status-badge.approved{background:rgba(16,185,129,0.12);color:#047857}
    .status-badge.processing{background:rgba(249,115,22,0.08);color:#c2410c}
    .status-badge.declined{background:rgba(239,68,68,0.08);color:#b91c1c}
    .status-badge.cancelled{background:rgba(107,114,128,0.08);color:#374151}
    .tx-note{font-size:13px;color:#334155}
  </style>
</head>
<body>
<header>
  <div>AmeerTech Deposit</div>
  <div><button class="btn btn-back" onclick="window.location.href='dashboard.html'">Back</button></div>
</header>
<div class="container">
  <div id="currentBox" class="card hidden" aria-live="polite">
    <h2>Current Transaction</h2>
    <div id="currentContent" class="center"></div>
  </div>

  <div id="depositForm" class="card">
    <h2>Add Fund</h2>
    <p style="color:red;font-weight:600">⚠ Minimum deposit ₦210 (₦200 per generate NIN)</p>
    <div id="step1">
      <label>Amount</label>
      <input type="number" id="depAmount" placeholder="Enter amount" required>
      <button class="btn btn-main" onclick="goStep2()">Next</button>
    </div>

    <div id="step2" class="hidden">
      <p style="color:red;font-weight:600">⚠ Minimum deposit ₦210</p>
      <p style="color:green;font-weight:600">Use account details below:</p>
      <table>
        <tr><th>Bank</th><td>Palmpay</td></tr>
        <tr><th>Account Name</th><td>Saleh Saleh Lawal</td></tr>
        <tr><th>Account Number</th><td>8145415083 <i class="fa fa-copy"></i></td></tr>
      </table>
      <button class="btn btn-back" onclick="backStep1()">Back</button>
      <button class="btn btn-main" onclick="goStep3()">I Have Sent</button>
    </div>

    <div id="step3" class="hidden">
      <h3>Sender Details</h3>
      <label>Sender Account Number</label>
      <input type="text" id="senderNo" maxlength="10" placeholder="10 digits only">
      <label>Bank</label>
      <input type="text" id="senderBank" placeholder="e.g. GTBank">
      <label>Transfer Date</label>
      <input type="date" id="senderDate" required>
      <label>Transfer Time</label>
      <input type="time" id="senderTime" required>
      <button class="btn btn-back" onclick="backStep2()">Back</button>
      <button class="btn btn-main" onclick="submitDeposit()">Submit</button>
    </div>
  </div>

  <div id="historyCard" class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
      <div>
        <h2 style="margin:0">History</h2>
        <div style="font-size:13px;color:#475569;margin-top:6px">Recent deposits (only)</div>
      </div>
      <div>
        <button class="btn" id="refreshHistoryBtn">Refresh</button>
      </div>
    </div>
    <div id="historyContent" class="history-list" style="margin-top:12px">
      <div id="historyLoader" class="empty-note">Loading deposits…</div>
      <div id="historyList" style="display:none"></div>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, push, set, update, onValue, get, child } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const firebaseConfig={
    apiKey:"AIzaSyDc0bIipHU7N73mju33dNwSWmH3IeIYkog",
    authDomain:"ameernin-ba310.firebaseapp.com",
    databaseURL:"https://ameernin-ba310-default-rtdb.firebaseio.com",
    projectId:"ameernin-ba310",
    storageBucket:"ameernin-ba310.appspot.com",
    messagingSenderId:"522206845073",
    appId:"1:522206845073:web:3c85714bd7eda6c1048730"
  };
  const app=initializeApp(firebaseConfig);
  const db=getDatabase(app);
  const auth = getAuth(app);

  let uid = null;
  let depositsUnsub = null;
  let txsUnsub = null;

  const currentBox=document.getElementById("currentBox");
  const currentContent=document.getElementById("currentContent");
  const depositForm=document.getElementById("depositForm");
  const historyLoader=document.getElementById("historyLoader");
  const historyListEl=document.getElementById("historyList");
  const refreshBtn=document.getElementById("refreshHistoryBtn");

  function goStep2(){ document.getElementById("step1").classList.add("hidden"); document.getElementById("step2").classList.remove("hidden"); }
  function goStep3(){ document.getElementById("step2").classList.add("hidden"); document.getElementById("step3").classList.remove("hidden"); }
  function backStep1(){ document.getElementById("step2").classList.add("hidden"); document.getElementById("step1").classList.remove("hidden"); }
  function backStep2(){ document.getElementById("step3").classList.add("hidden"); document.getElementById("step2").classList.remove("hidden"); }
  window.goStep2=goStep2; window.goStep3=goStep3; window.backStep1=backStep1; window.backStep2=backStep2;

  // debounce loader
  let loadTimer = null;
  function scheduleLoadDeposits(delay = 250){
    if(loadTimer) clearTimeout(loadTimer);
    loadTimer = setTimeout(() => {
      loadDeposits().catch(e => console.error('loadDeposits error (scheduled)', e));
      loadTimer = null;
    }, delay);
  }

  onAuthStateChanged(auth, (user) => {
    try{ if(depositsUnsub) depositsUnsub(); }catch(e){}
    try{ if(txsUnsub) txsUnsub(); }catch(e){}
    if(user){
      uid = user.uid;
      localStorage.setItem("currentUserId", uid);
      depositsUnsub = onValue(ref(db, `deposits/${uid}`), () => scheduleLoadDeposits());
      txsUnsub = onValue(ref(db, `users/${uid}/transactions`), () => scheduleLoadDeposits());
      scheduleLoadDeposits();
    } else {
      uid = null;
      localStorage.removeItem("currentUserId");
      window.location.href = "auth.html";
    }
  });

  async function hasPendingDepositOnce(){
    if(!uid) return false;
    try{
      const snap = await get(child(ref(db), `deposits/${uid}`));
      if(!snap.exists()) return false;
      let pending = false;
      snap.forEach(ch=>{
        const d = ch.val();
        const s = (d.status||'').toString().toLowerCase();
        if(s === 'submitted' || s === 'processing') pending = true;
      });
      return pending;
    }catch(e){
      console.error('pending check failed', e);
      return false;
    }
  }

  // ---------- submitDeposit: atomic multi-path write ----------
  window.submitDeposit = async function(){
    if(!uid){
      alert("You must be signed in to submit a deposit.");
      return;
    }

    const amt = Number(document.getElementById("depAmount").value || 0);
    if(!amt || amt < 210){
      alert("Minimum deposit ₦210");
      return;
    }

    const pending = await hasPendingDepositOnce();
    if(pending){
      alert("You already have a pending deposit (submitted/processing). Wait for admin action before submitting another.");
      return;
    }

    const no = document.getElementById("senderNo").value.trim();
    const bank = document.getElementById("senderBank").value.trim();
    const d = document.getElementById("senderDate").value;
    const t = document.getElementById("senderTime").value;

    console.log("Submitting deposit", { uid, amt, no, bank, d, t, authUser: auth.currentUser && auth.currentUser.uid });

    try{
      // reserve keys
      const depRef = push(ref(db, `deposits/${uid}`));
      const depId = depRef.key;
      const txRef = push(ref(db, `users/${uid}/transactions`));
      const txId = txRef.key;

      const now = Date.now();
      const depositObj = {
        amount: amt,
        accountNo: no || "",
        bank: bank || "",
        date: d || new Date().toLocaleDateString(),
        timeTxt: t || new Date().toLocaleTimeString(),
        status: "submitted",
        timestamp: now,
        updatedAt: now,
        txKey: txId
      };

      const txObj = {
        type: 'credit',
        action: 'deposit',
        amount: amt,
        timestamp: now,
        status: 'submitted',
        depositId: depId,
        updatedAt: now,
        createdBy: 'user'
      };

      // multi-path update (atomic)
      const updates = {};
      updates[`deposits/${uid}/${depId}`] = depositObj;
      updates[`users/${uid}/transactions/${txId}`] = txObj;

      await update(ref(db), updates);

      // UI update (same UX as before)
      document.getElementById("step3").classList.add("hidden");
      document.getElementById("step1").classList.remove("hidden");
      depositForm.classList.add("hidden");
      currentBox.classList.remove("hidden");
      currentContent.innerHTML=`
        <div><i class="fa fa-check-circle icon-big success"></i></div>
        <p>Submitted successfully.<br>Waiting approval...</p>
        <small>${depositObj.date} ${depositObj.timeTxt}</small>
      `;

      // optional UX transition to processing
      setTimeout(async ()=>{
        try{
          const u = {};
          u[`deposits/${uid}/${depId}/status`] = "processing";
          u[`deposits/${uid}/${depId}/updatedAt`] = Date.now();
          u[`users/${uid}/transactions/${txId}/status`] = "processing";
          u[`users/${uid}/transactions/${txId}/updatedAt`] = Date.now();
          await update(ref(db), u);
          loadDeposits();
        }catch(e){ console.error('processing update failed', e); }
      }, 3000);

    }catch(e){
      console.error("submitDeposit failed", e && (e.code || e.message) ? (e.code || e.message) : e);
      alert("Failed to submit deposit. Check console (F12) for details.");
    }
  };

  // ---------- load deposits-only history & current ----------
  async function loadDeposits(){
    if(!uid){
      historyLoader.textContent = 'Not signed in.';
      return;
    }

    historyLoader.style.display = 'block';
    historyListEl.style.display = 'none';
    historyListEl.innerHTML = '';
    try{
      const snap = await get(child(ref(db), `deposits/${uid}`));
      if(!snap.exists()){
        historyLoader.textContent = 'No deposits yet.';
        currentBox.classList.add('hidden');
        depositForm.classList.remove('hidden');
        return;
      }

      const arr = [];
      snap.forEach(ch=>{
        arr.push({ id: ch.key, ...ch.val() });
      });
      arr.sort((a,b)=> (b.updatedAt || b.timestamp || 0) - (a.updatedAt || a.timestamp || 0));

      const latest = arr[0];
      renderCurrent(latest, arr);

      arr.slice(0,20).forEach(d=>{
        const item = document.createElement('div');
        item.className = 'tx-item';
        const left = document.createElement('div'); left.className='tx-left';
        const title = document.createElement('div');
        const amtSpan = document.createElement('span'); amtSpan.className='tx-amount'; amtSpan.textContent = '₦' + Number(d.amount||0).toLocaleString();
        const typeSpan = document.createElement('span'); typeSpan.className = 'tx-type credit'; typeSpan.textContent = 'DEPOSIT';
        title.appendChild(typeSpan);
        title.appendChild(amtSpan);

        const status = (d.status||'').toString().toLowerCase();
        if(status){
          const sb = document.createElement('span'); sb.className = 'status-badge ' + status; sb.textContent = status.toUpperCase();
          title.appendChild(sb);
        }

        const note = document.createElement('div'); note.className='tx-note';
        note.textContent = d.accountNo ? `From: ${d.accountNo} (${d.bank||''})` : (d.note||'Deposit record');
        left.appendChild(title);
        left.appendChild(note);

        const right = document.createElement('div'); right.className='tx-date';
        const ts = d.updatedAt || d.timestamp || Date.now();
        right.textContent = new Date(Number(ts)).toLocaleString();

        item.appendChild(left); item.appendChild(right);
        historyListEl.appendChild(item);
      });

      historyLoader.style.display='none';
      historyListEl.style.display='block';
    }catch(e){
      console.error('loadDeposits failed', e);
      historyLoader.textContent = 'Failed to load deposits.';
    }
  }

  function renderCurrent(latest, allDeposits){
    if(!latest){
      currentBox.classList.add('hidden');
      depositForm.classList.remove('hidden');
      return;
    }
    currentBox.classList.remove('hidden');

    const s = (latest.status||'').toString().toLowerCase();
    if(s === 'submitted' || s === 'processing'){
      depositForm.classList.add('hidden');
    } else {
      const anyPending = allDeposits.some(d => {
        const st = (d.status||'').toString().toLowerCase();
        return st === 'submitted' || st === 'processing';
      });
      if(anyPending) depositForm.classList.add('hidden');
      else depositForm.classList.remove('hidden');
    }

    if(s === 'submitted'){
      currentContent.innerHTML=`
        <div><i class="fa fa-check-circle icon-big success"></i></div>
        <p>Submitted successfully.<br>Waiting approval...</p>
        <small>${latest.date||""} ${latest.timeTxt||""}</small>
      `;
    } else if(s === 'processing'){
      currentContent.innerHTML=`
        <div class="circle"><i class="fa fa-clock icon-big processing"></i></div>
        <p>Transaction processing ₦${latest.amount}...</p>
        <small>${latest.date||""} ${latest.timeTxt||""}</small>
      `;
    } else if(s === 'approved'){
      currentContent.innerHTML=`
        <div><i class="fa fa-check-circle icon-big success"></i></div>
        <p>Your transaction of ₦${latest.amount} was successful.<br>Check your dashboard.</p>
        <small>${latest.date||""} ${latest.timeTxt||""}</small>
      `;
    } else if(s === 'declined'){
      currentContent.innerHTML=`
        <div><i class="fa fa-times-circle icon-big decline"></i></div>
        <p>Your transaction of ₦${latest.amount} was declined.<br>Not added to dashboard.</p>
        <small>${latest.date||""} ${latest.timeTxt||""}</small>
      `;
    } else if(s === 'cancelled'){
      currentContent.innerHTML=`
        <div><i class="fa fa-ban icon-big cancel"></i></div>
        <p>Transaction cancelled: Not received transfer.</p>
        <small>${latest.date||""} ${latest.timeTxt||""}</small>
      `;
    } else {
      currentContent.innerHTML=`
        <div><i class="fa fa-info-circle icon-big"></i></div>
        <p>Last deposit: ₦${latest.amount} — ${latest.status || '—'}</p>
        <small>${latest.date||""} ${latest.timeTxt||""}</small>
      `;
    }
  }

  refreshBtn.addEventListener('click', loadDeposits);

</script>
</body>
</html>