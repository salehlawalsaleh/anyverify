<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Deposit | AnyVerify</title>
  <script src="https://js.paystack.co/v1/inline.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-50 min-h-screen flex flex-col items-center p-4">
  <div class="w-full max-w-md bg-white rounded-2xl shadow-lg p-6 space-y-6 mt-6">

    <h1 class="text-2xl font-semibold text-center text-indigo-600">Deposit Funds</h1>
    <p class="text-center text-sm text-gray-500">Active pending deposits will auto-cancel after 30 minutes</p>

    <form id="depositForm" class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Amount (₦)</label>
        <input id="amount" name="amount" type="number" min="100" required
          class="w-full border rounded-lg p-2 focus:ring-2 focus:ring-indigo-500" />
      </div>

      <button id="payBtn" type="submit"
        class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-lg transition">
        Pay with Paystack
      </button>
    </form>

    <div id="pendingMsg" class="hidden text-yellow-600 text-sm text-center"></div>
    <div id="errorMsg" class="hidden text-red-500 text-sm text-center"></div>

    <div class="border-t pt-4">
      <div class="flex justify-between items-center mb-2">
        <h2 class="text-lg font-medium text-gray-800">Recent Deposits</h2>
        <button id="refreshBtn"
          class="text-sm text-indigo-600 hover:underline">Refresh</button>
      </div>
      <div id="history" class="space-y-2 text-sm text-gray-600">
        <p class="text-center text-gray-400">Loading history...</p>
      </div>
    </div>

  </div>

  <script type="module">
    // NOTE: replace demoUser/demo email with real auth values in production
    const uid = localStorage.getItem('uid') || 'demoUser';
    const email = localStorage.getItem('email') || 'test@example.com';
    const baseUrl = '/.netlify/functions';

    const depositForm = document.getElementById('depositForm');
    const errorMsg = document.getElementById('errorMsg');
    const pendingMsg = document.getElementById('pendingMsg');
    const historyDiv = document.getElementById('history');
    const refreshBtn = document.getElementById('refreshBtn');
    const payBtn = document.getElementById('payBtn');

    let paystackPublicKey = null;

    async function getConfig() {
      try {
        const res = await fetch(`${baseUrl}/getConfig`);
        if (!res.ok) throw new Error('Failed to load config');
        const json = await res.json();
        paystackPublicKey = json.PAYSTACK_PUBLIC || '';
      } catch (err) {
        console.error('getConfig error', err);
        paystackPublicKey = '';
      }
    }

    async function loadDeposits() {
      historyDiv.innerHTML = `<p class='text-center text-gray-400'>Loading...</p>`;
      try {
        const res = await fetch(`${baseUrl}/getDeposits?uid=${encodeURIComponent(uid)}`);
        if (!res.ok) throw new Error('Failed to fetch deposits');
        const payload = await res.json();
        const data = payload.deposits || {};
        const deposits = Object.entries(data)
          .map(([id, d]) => ({ id, ...d }))
          .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));

        const pending = deposits.filter(d => d.status === 'pending');
        if (pending.length >= 3) {
          pendingMsg.classList.remove('hidden');
          pendingMsg.textContent = `You have ${pending.length} active pending deposits.`;
        } else {
          pendingMsg.classList.add('hidden');
        }

        const recent = deposits.slice(0, 3);
        if (recent.length === 0) {
          historyDiv.innerHTML = `<p class='text-center text-gray-400'>No deposits found.</p>`;
        } else {
          historyDiv.innerHTML = recent.map((d) => `
            <div class="flex justify-between bg-gray-100 rounded-lg p-2">
              <span>₦${d.amount}</span>
              <span class="${d.status === 'approved' ? 'text-green-600' : d.status === 'pending' ? 'text-yellow-600' : 'text-red-500'}">
                ${d.status}
              </span>
            </div>
          `).join('');
        }
      } catch (err) {
        console.error('loadDeposits failed', err);
        historyDiv.innerHTML = `<p class='text-center text-red-500'>Failed to load deposits. Try refresh.</p>`;
      }
    }

    refreshBtn.addEventListener('click', loadDeposits);

    async function initializePaymentOnServer(amount) {
      const res = await fetch(`${baseUrl}/initializePayment`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ uid, amount, email }),
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || (data.details && JSON.stringify(data.details)) || 'Initialize failed');
      return data;
    }

    depositForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      errorMsg.classList.add('hidden');

      const amount = parseFloat(document.getElementById('amount').value);
      if (!amount || amount < 100) return alert('Minimum ₦100');

      // disable button while processing
      payBtn.disabled = true;
      payBtn.textContent = 'Processing...';

      try {
        // ensure we have public key
        if (!paystackPublicKey) {
          await getConfig();
          if (!paystackPublicKey) {
            throw new Error('Payment configuration missing. Contact support.');
          }
        }

        const initData = await initializePaymentOnServer(amount);

        // Use Paystack inline
        const handler = PaystackPop.setup({
          key: paystackPublicKey,
          email: email,
          amount: Math.round(amount * 100),
          ref: initData.reference, // server generated reference
          callback: function (response) {
            // server-side verify
            fetch(`${baseUrl}/verifyPayment`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ reference: response.reference }),
            })
            .then(() => loadDeposits())
            .catch(err => {
              console.error('verifyPayment call failed', err);
              loadDeposits();
            });
          },
          onClose: function () {
            alert('Transaction was not completed');
          },
        });
        handler.openIframe();
      } catch (err) {
        console.error('init payment error', err);
        errorMsg.textContent = (err && err.message) || 'Failed to initialize payment';
        errorMsg.classList.remove('hidden');
      } finally {
        payBtn.disabled = false;
        payBtn.textContent = 'Pay with Paystack';
      }
    });

    // initial actions
    (async () => {
      await getConfig();
      await loadDeposits();
    })();
  </script>
</body>
</html>
