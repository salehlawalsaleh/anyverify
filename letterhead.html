<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Letterhead — Multi-step (Clean)</title>

<!-- Google fonts: Poppins + heavy display fonts for company name -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&family=Archivo+Black&family=Anton&family=Bebas+Neue&family=Montserrat:wght@700;800&family=Rubik:wght@700&display=swap" rel="stylesheet">

<style>
:root{
  --accent:#0d2a63;
  --accent2:#092042;
  --muted:#6b7280;
  --text:#111;
  --card-bg:#fff;
  --bg:#f6f7fb;
  --radius:12px;
  --toast-bg: rgba(17,24,39,0.95);
  --toast-color: #fff;
  --toast-success: #16a34a;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;padding:0;background:var(--bg);color:var(--text);font-family:"Poppins", Arial, sans-serif}
.container{max-width:1180px;margin:18px auto;display:grid;grid-template-columns:1fr 520px;gap:18px;align-items:start;padding:0 16px}
.card{background:var(--card-bg);padding:16px;border-radius:var(--radius);box-shadow:0 8px 28px rgba(10,20,40,0.06)}
h2{ margin:0 0 12px; color:var(--accent); font-size:18px }

/* steps */
.steps{ display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap }
.pill{ flex:1; padding:8px 10px; background:#eef2ff; color:var(--accent2); border-radius:8px; text-align:center; font-weight:700; font-size:13px; display:flex; align-items:center; justify-content:center }
.pill.active{ background:linear-gradient(90deg,var(--accent),var(--accent2)); color:#fff; box-shadow:0 6px 18px rgba(13,42,99,0.12) }

/* single-column form (clean modern) */
.form-field{ display:block; margin-bottom:14px }
.form-field label{ display:block; font-size:13px; color:#374151; margin-bottom:8px; font-weight:600 }
.form-field input[type="text"], .form-field input[type="email"], .form-field input[type="file"], .form-field textarea, .form-field input[type="checkbox"]{
  width:100%; padding:12px 14px; border:1px solid #e6e9ef; border-radius:12px; font-size:15px; background:#fff; box-shadow:0 2px 8px rgba(10,20,40,0.03);
}
.form-field .inline{ width:auto; padding:0; border:none; background:transparent; box-shadow:none; }
.field-error{ color:#b91c1c; font-size:13px; margin-top:6px; display:none; }

/* clean modern logo preview */
.logo-preview{
  width:112px;
  height:112px;
  border-radius:16px;
  background:linear-gradient(145deg,#ffffff,#e6eefb);
  border:1px solid #dbeafe;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:800;
  font-size:36px;
  color:var(--accent);
  box-shadow:inset 4px 4px 10px rgba(255,255,255,0.7), 0 10px 24px rgba(13,42,99,0.12);
  overflow:hidden;
}
.logo-preview canvas{ width:100%; height:100%; display:block }

/* controls */
.controls{ display:flex; gap:8px; justify-content:flex-end; margin-top:8px; flex-wrap:wrap }
button{ background:var(--accent); color:#fff; border:0; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:700; display:inline-flex; align-items:center; gap:8px }
button.secondary{ background:#fff; color:var(--accent); border:1px solid #e6e9ef; font-weight:700 }
.muted{ color:var(--muted); font-size:13px }

/* tiny inline spinner used on buttons */
.btn-spinner{ width:16px; height:16px; border-radius:50%; border:2px solid rgba(255,255,255,0.3); border-top-color:#fff; animation:spin 0.9s linear infinite; display:inline-block }
.btn-spinner.dark{ border:2px solid rgba(13,42,99,0.15); border-top-color:var(--accent); }

/* preview column styles (only shown in step 4 or after generate) */
.preview{ display:flex; flex-direction:column; gap:12px }
.preview-box{ background:var(--card-bg); border-radius:10px; padding:12px; box-shadow:0 8px 20px rgba(8,18,41,0.06); position:relative; overflow:hidden }
.canvas-wrap{ width:100%; border:1px solid #eef2f7; display:flex; justify-content:center; align-items:center; padding:10px; background:#fbfcff; position:relative; overflow:hidden; min-height:220px }
.scaled-canvas{ width:100%; height:auto; max-width:210mm; border-radius:6px; box-shadow:0 8px 14px rgba(13,42,99,0.06); display:block }

/* overlay progress */
.overlay { position:absolute; inset:0; display:flex; align-items:flex-start; justify-content:center; background: rgba(255,255,255,0.0); transition: opacity .25s; pointer-events:none; opacity:0; padding-top:20px; }
.overlay.show{ opacity:1; pointer-events:auto; backdrop-filter: blur(10px); background: rgba(255,255,255,0.65); }
.progress-box{ width:360px; max-width:92%; padding:14px 18px; border-radius:12px; background:#fff; box-shadow:0 10px 30px rgba(0,0,0,0.08); text-align:center; margin-top:6px; }

/* progress bar & spinner row */
.progress-row{ display:flex; align-items:center; justify-content:center; gap:12px; margin-top:8px; flex-direction:row; }
.progress-bar{ width:100%; height:10px; background:#eef2ff; border-radius:8px; overflow:hidden; margin-top:12px; }
.progress-fill{ height:100%; width:0%; background:linear-gradient(90deg,var(--accent),var(--accent2)); border-radius:8px; transition:width .12s linear; }

/* circular spinner */
.spinner{
  width:34px; height:34px; border-radius:50%; border:4px solid rgba(13,42,99,0.12);
  border-top-color:var(--accent); animation:spin 1s linear infinite; display:inline-block;
}
@keyframes spin{ to{ transform:rotate(360deg) } }
.progress-text{ font-weight:800; color:var(--accent); margin-top:8px; font-size:18px }

/* preview banner & locked overlay */
.preview-banner{margin-top:12px;padding:10px;border-radius:8px;display:flex;align-items:center;justify-content:space-between;gap:10px;font-weight:700}
.preview-banner.warn{background:#fff7f6;color:#9b1c1c;border:1px solid #fecaca}
.preview-banner.info{background:#ecfdf5;color:#065f46;border:1px solid #bbf7d0}

.locked-overlay{
  position:absolute; inset:12px; display:flex; align-items:center; justify-content:center; border-radius:10px;
  background:rgba(255,255,255,0.95); z-index:40; flex-direction:column; gap:12px;
}

/* toast */
.toast-wrap{ position:fixed; right:18px; top:18px; z-index:999999; display:flex; flex-direction:column; gap:8px; align-items:flex-end }
.toast{ background:var(--toast-bg); color:var(--toast-color); padding:10px 14px; border-radius:10px; box-shadow:0 8px 30px rgba(2,6,23,0.4); font-weight:700; opacity:0; transform:translateY(-6px); transition:all .25s }
.toast.show{ opacity:1; transform:translateY(0) }
.toast.success{ background:var(--toast-success); color:#fff; }

/* responsive */
@media (max-width:1100px){ .container{ grid-template-columns:1fr } .pill{ font-size:12px; padding:6px 8px } }
@media (max-width:700px){ body{ padding:12px } .card{ padding:12px } .controls{ flex-direction:column-reverse } .controls button{ width:100% } .scaled-canvas{ max-width:100%; width:100% } }
</style>
</head>
<body>
<div class="toast-wrap" id="toastWrap" aria-live="polite" aria-atomic="true"></div>

<div class="container">
  <!-- LEFT: multi-step form -->
  <div class="card" aria-labelledby="formTitle">
    <h2 id="formTitle">Letterhead — Multi-step</h2>

    <div class="steps" id="steps">
      <div class="pill active" data-step="1">1. Info</div>
      <div class="pill" data-step="2">2. Logo</div>
      <div class="pill" data-step="3">3. Review</div>
      <div class="pill" data-step="4">4. Generate</div>
    </div>

    <form id="msForm" onsubmit="return false;" autocomplete="off">
      <!-- STEP 1 -->
      <div class="panel" data-step="1">
        <div class="form-field">
          <label for="company">Company name *</label>
          <input id="company" type="text" placeholder="e.g. Ameer Technology Company" required>
          <div id="companyError" class="field-error">Company name is required.</div>
        </div>

        <div class="form-field">
          <label for="nature">Nature of business *</label>
          <input id="nature" type="text" placeholder="e.g. General, Marketing, School, Ministry" required>
          <div id="natureError" class="field-error">Nature of business is required.</div>
        </div>

        <div class="form-field">
          <label for="address">Address (appears under Nature) *</label>
          <input id="address" type="text" placeholder="e.g. Central Market Park, Bauchi" required>
          <div id="addressError" class="field-error">Address is required.</div>
        </div>

        <div class="form-field">
          <label for="phone">Phone (digits only, max 11)</label>
          <input id="phone" type="text" inputmode="numeric" placeholder="e.g. 08012345678" pattern="\d{7,11}">
          <div class="hint">Only digits, maximum 11 characters.</div>
          <div id="phoneError" class="field-error">Phone must be 7–11 digits if provided.</div>
        </div>

        <div class="form-field">
          <label for="email">Email (will be shown on top-right)</label>
          <input id="email" type="email" placeholder="info@ameertech.com">
          <div id="emailError" class="field-error">Please provide a valid email address.</div>
        </div>

        <div class="controls">
          <div style="flex:1" class="muted">All fields marked * are required.</div>
          <div style="display:flex; gap:8px;">
            <button id="backToDashboard1" type="button" class="secondary">← Dashboard</button>
            <button id="toStep2" type="button" class="secondary">Next →</button>
          </div>
        </div>
      </div>

      <!-- STEP 2 -->
      <div class="panel" data-step="2" style="display:none;">
        <div class="form-field">
          <label for="logoFile">Upload logo (optional)</label>
          <input id="logoFile" type="file" accept="image/*">
        </div>

        <div class="form-field inline" style="margin-bottom:10px;">
          <label style="display:flex; align-items:center; gap:10px; font-weight:600;">
            <input id="useUploadedIf" type="checkbox" checked style="width:18px; height:18px; margin:0;"> 
            Use uploaded logo for final output (if checked and logo uploaded)
          </label>
        </div>

        <div style="display:flex; gap:12px; align-items:center; margin-bottom:12px;">
          <!-- clean modern logo preview -->
          <div id="logoPreview" class="logo-preview">ASD</div>
          <div class="muted">Preview thumbnail — final output will use uploaded logo only if the checkbox above is checked. Otherwise the system will generate a random HD logo.</div>
        </div>

        <div class="controls">
          <button id="back1" type="button" class="secondary">← Prev</button>
          <button id="backToDashboard2" type="button" class="secondary">← Dashboard</button>
          <button id="toStep3" type="button">Next →</button>
        </div>
      </div>

      <!-- STEP 3 -->
      <div class="panel" data-step="3" style="display:none;">
        <h3 style="margin:0 0 10px">Review</h3>
        <div style="margin-bottom:10px">
          <strong>Company:</strong> <span id="revCompany">—</span><br>
          <strong>Nature:</strong> <span id="revNature">—</span><br>
          <strong>Address:</strong> <span id="revAddress">—</span><br>
          <strong>Phone:</strong> <span id="revPhone">—</span><br>
          <strong>Email:</strong> <span id="revEmail">—</span>
        </div>

        <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
          <div>
            <div id="revLogo" class="logo-preview" style="background:#f8fafc;color:var(--accent);">logo</div>
            <div id="revUseUploaded" class="muted" style="text-align:center;margin-top:6px">Using uploaded for final: —</div>
          </div>
          <div class="muted">Confirm details. Nothing is generated until you press Generate.</div>
        </div>

        <div class="controls">
          <button id="back2" type="button" class="secondary">← Prev</button>
          <button id="backToDashboard3" type="button" class="secondary">← Dashboard</button>
          <button id="toStep4" type="button">Next →</button>
        </div>
      </div>

      <!-- STEP 4 -->
      <div class="panel" data-step="4" style="display:none;">
        <h3 style="margin:0 0 8px">Generate</h3>
        <p class="muted">Press "Generate my letter head" — progress (%) will appear while processing. If balance ≥ ₦200 we will deduct ₦200 and enable downloads; otherwise a demo (watermarked) preview is shown up to 5 times, after which preview will be blocked</p>
        <div class="controls">
          <button id="back3" type="button" class="secondary">← Prev</button>
          <button id="backToDashboard4" type="button" class="secondary">← Dashboard</button>
          <button id="generateNow" type="button">Generate my letter head</button>
        </div>
      </div>
    </form>
  </div>

  <!-- RIGHT: preview column (hidden in Steps 1-3) -->
  <div id="previewColumn" class="preview" style="display:none;">
    <div class="card preview-box" id="previewBox" aria-live="polite">
      <div id="previewHeader" style="display:flex; align-items:center; justify-content:space-between; margin-bottom:8px;">
        <strong>Preview (appears after Generate)</strong>
        <div style="display:flex; gap:8px;">
          <button id="downloadPng" class="secondary" disabled>Download PNG</button>
          <button id="downloadPdf" disabled>Download PDF</button>
        </div>
      </div>

      <div class="canvas-wrap" id="canvasWrap" style="display:block">
        <img id="previewImage" class="scaled-canvas" alt="Letterhead preview" style="display:none">
        <div class="overlay" id="overlay" aria-hidden="true">
          <div class="progress-box" role="status" aria-live="assertive">
            <div style="font-weight:800;color:var(--accent);font-size:16px">Generating your letterhead</div>

            <!-- NEW: spinner + progress row -->
            <div class="progress-row">
              <div class="spinner" id="progressSpinner" aria-hidden="true"></div>
              <div style="flex:1">
                <div class="progress-bar" aria-hidden="true"><div class="progress-fill" id="progressFill"></div></div>
                <div style="display:flex; align-items:center; justify-content:center; gap:8px;">
                  <div class="progress-text" id="progressText">0%</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="previewBanner" class="preview-banner hidden"></div>
      <div class="muted" style="margin-top:10px">Note: preview & downloads visible only at Step 4 (or after Generate).</div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="muted">After generation you can download PNG (A4 @300dpi) or PDF.</div>
    </div>
  </div>
</div>

<!-- jsPDF + Firebase (module) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, get, runTransaction, set, push, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDc0bIipHU7N73mju33dNwSWmH3IeIYkog",
    authDomain: "ameernin-ba310.firebaseapp.com",
    databaseURL: "https://ameernin-ba310-default-rtdb.firebaseio.com",
    projectId: "ameernin-ba310",
    storageBucket: "ameernin-ba310.appspot.com",
    messagingSenderId: "522206845073",
    appId: "1:522206845073:web:3c85714bd7eda6c1048730",
  };
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);

  // ========== App variables & DOM ==========
  const DPI = 300;
  const A4_MM = { w:210, h:297 };
  const A4_PX = { w: Math.round((A4_MM.w/25.4) * DPI), h: Math.round((A4_MM.h/25.4) * DPI) };
  const canvas = document.createElement('canvas'); // big A4 canvas (not in DOM)
  canvas.width = A4_PX.w; canvas.height = A4_PX.h;
  const ctx = canvas.getContext('2d', { alpha:false });

  const panels = [...document.querySelectorAll('.panel')];
  const pills = [...document.querySelectorAll('.pill')];
  const previewImage = document.getElementById('previewImage');
  const overlay = document.getElementById('overlay');
  const progressFill = document.getElementById('progressFill');
  const progressText = document.getElementById('progressText');
  const previewColumn = document.getElementById('previewColumn');
  const previewBox = document.getElementById('previewBox');
  const previewBanner = document.getElementById('previewBanner');
  const progressSpinner = document.getElementById('progressSpinner');

  const companyEl = document.getElementById('company');
  const natureEl = document.getElementById('nature');
  const emailEl = document.getElementById('email');
  const addressEl = document.getElementById('address');
  const phoneEl = document.getElementById('phone');
  const logoFile = document.getElementById('logoFile');
  const logoPreview = document.getElementById('logoPreview');
  const useUploadedIf = document.getElementById('useUploadedIf');

  const revCompany = document.getElementById('revCompany');
  const revNature = document.getElementById('revNature');
  const revAddress = document.getElementById('revAddress');
  const revPhone = document.getElementById('revPhone');
  const revEmail = document.getElementById('revEmail');
  const revLogo = document.getElementById('revLogo');
  const revUseUploaded = document.getElementById('revUseUploaded');

  const downloadPngBtn = document.getElementById('downloadPng');
  const downloadPdfBtn = document.getElementById('downloadPdf');

  const toastWrap = document.getElementById('toastWrap');

  let currentLogoDataUrl = null;
  let generatedOk = false;

  // ===== randomization options (new) =====
  const BOLD_COMPANY_FONTS = ['Anton','"Archivo Black"','"Bebas Neue"','"Montserrat"','Rubik'];
  const NATURE_FONTS = ['"Times New Roman"','Georgia','Merriweather','Lora'];
  const COMPANY_COLORS = [
    '#07124b', '#007bff', '#10b981', '#064e3b', '#000000', '#1e90ff', '#7c3aed', '#f97316', '#f59e0b', '#ec4899'
  ];
  let lastRandomStyle = null;

  const DEMO_LIMIT = 5; // updated per request

  // ========== helper: toast & button spinner ==========
  function showToast(msg, opts = {timeout:3000, type: 'default'}){
    const t = document.createElement('div');
    t.className = 'toast';
    if(opts.type === 'success') t.classList.add('success');
    t.textContent = msg;
    toastWrap.appendChild(t);
    requestAnimationFrame(()=> t.classList.add('show'));
    const to = setTimeout(()=> {
      t.classList.remove('show');
      setTimeout(()=> t.remove(), 220);
    }, opts.timeout || 3000);
    t.addEventListener('click', ()=> {
      clearTimeout(to);
      t.classList.remove('show');
      setTimeout(()=> t.remove(), 180);
    });
  }

  function withBtnSpinner(btn, fn){
    if(!btn) return Promise.resolve();
    btn.disabled = true;
    const spinner = document.createElement('span'); spinner.className = 'btn-spinner dark';
    btn.appendChild(spinner);
    try{
      const res = fn();
      if(res && res.then) {
        return res.finally(()=> { spinner.remove(); btn.disabled=false; });
      } else {
        spinner.remove(); btn.disabled=false;
        return Promise.resolve(res);
      }
    }catch(e){
      spinner.remove(); btn.disabled=false;
      return Promise.reject(e);
    }
  }

  // Auth + init
  let uid = null;
  onAuthStateChanged(auth, async (user) => {
    if(!user){
      try{ localStorage.removeItem('currentUserId'); }catch(e){}
      window.location.href = 'auth.html';
      return;
    }
    uid = user.uid;
    try{ localStorage.setItem('currentUserId', uid); }catch(e){}
    try{
      const snap = await get(ref(db, `users/${uid}`));
      if(!snap.exists()){ localStorage.clear(); window.location.href = 'auth.html'; return; }
      const obj = snap.val();
      if(obj.status === 'blocked' || obj.blocked === true){
        try{ await update(ref(db, `users/${uid}`), { status: 'blocked' }); }catch(e){}
        localStorage.clear();
        document.body.innerHTML = '<div style="padding:24px;text-align:center">Account blocked. Contact support.</div>';
        return;
      }
      try{ localStorage.setItem('balance', (obj.balance || 0)); }catch(e){}
    }catch(err){
      console.error('init error', err);
      localStorage.clear();
      window.location.href = 'auth.html';
      return;
    }
    showStep(1);
  });

  // UI step handling
  let currentStep = 1;
  function showStep(n){
    currentStep = n;
    panels.forEach(p => p.style.display = (Number(p.dataset.step) === n) ? '' : 'none');
    pills.forEach(p => {
      if(Number(p.dataset.step) === n){
        p.style.display = 'flex';
        p.classList.add('active');
      } else {
        p.style.display = 'none';
        p.classList.remove('active');
      }
    });
    previewColumn.style.display = (n === 4 || generatedOk) ? 'flex' : 'none';
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  // validation helper
  function validatePanel(panel){
    const inputs = [...panel.querySelectorAll('input')];
    for(const inp of inputs){
      const id = inp.id;
      if(inp.required && !inp.value.trim()){
        const errEl = document.getElementById((id||'') + 'Error');
        if(errEl) errEl.style.display = 'block';
        inp.focus();
        showToast('Please enter the required field: ' + (inp.previousElementSibling ? inp.previousElementSibling.textContent : id));
        return false;
      } else {
        const errEl = document.getElementById((id||'') + 'Error');
        if(errEl) errEl.style.display = 'none';
      }
      if(inp.id === 'phone' && inp.value.trim()){
        const onlyDigits = inp.value.replace(/\D/g,'');
        if(onlyDigits.length < 7 || onlyDigits.length > 11){
          document.getElementById('phoneError').style.display='block';
          inp.focus();
          showToast('Phone must be between 7 and 11 digits.');
          return false;
        } else {
          document.getElementById('phoneError').style.display='none';
        }
      }
      if(inp.id === 'email' && inp.value.trim()){
        try{
          const v = inp.value.trim();
          const ok = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);
          if(!ok){ document.getElementById('emailError').style.display='block'; inp.focus(); showToast('Please provide a valid email address.'); return false; }
          else document.getElementById('emailError').style.display='none';
        }catch(e){}
      }
    }
    return true;
  }

  // nav wiring
  document.getElementById('toStep2').addEventListener('click', () => {
    const panel = panels.find(p => Number(p.dataset.step) === 1);
    if(!validatePanel(panel)) return;
    withBtnSpinner(document.getElementById('toStep2'), ()=> { updateLogoInitials(); showStep(2); });
  });
  document.getElementById('back1').addEventListener('click', ()=> showStep(1));
  document.getElementById('toStep3').addEventListener('click', () => {
    const panel = panels.find(p => Number(p.dataset.step) === 2);
    if(!validatePanel(panel)) return;
    withBtnSpinner(document.getElementById('toStep3'), ()=> {
      document.getElementById('revCompany').textContent = companyEl.value.trim() || '—';
      document.getElementById('revNature').textContent = natureEl.value.trim() || '—';
      document.getElementById('revAddress').textContent = addressEl.value.trim() || '—';
      document.getElementById('revPhone').textContent = phoneEl.value.trim() || '—';
      document.getElementById('revEmail').textContent = emailEl.value.trim() || '—';
      revLogo.innerHTML = logoPreview.outerHTML;
      revUseUploaded.textContent = 'Using uploaded for final: ' + ((useUploadedIf && useUploadedIf.checked && currentLogoDataUrl) ? 'Yes' : 'No');
      showStep(3);
    });
  });
  document.getElementById('back2').addEventListener('click', ()=> showStep(2));
  document.getElementById('toStep4').addEventListener('click', ()=> {
    const panel = panels.find(p => Number(p.dataset.step) === 3);
    if(!validatePanel(panel)) return;
    withBtnSpinner(document.getElementById('toStep4'), ()=> { updateLogoInitials(); showStep(4); });
  });
  document.getElementById('back3').addEventListener('click', ()=> showStep(3));
  ['backToDashboard1','backToDashboard2','backToDashboard3','backToDashboard4'].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.addEventListener('click', ()=> { window.location.href='dashboard.html'; });
  });

  // phone sanitisation
  phoneEl.addEventListener('input', (e) => {
    let v = e.target.value || '';
    v = v.replace(/\D/g,'');
    if(v.length > 11) v = v.slice(0,11);
    e.target.value = v;
  });

  // canvas helpers
  function roundRect(ctxLocal, x, y, w, h, r){
    ctxLocal.beginPath();
    ctxLocal.moveTo(x + r, y);
    ctxLocal.arcTo(x + w, y, x + w, y + h, r);
    ctxLocal.arcTo(x + w, y + h, x, y + h, r);
    ctxLocal.arcTo(x, y + h, x, y, r);
    ctxLocal.arcTo(x, y, x + w, y, r);
    ctxLocal.closePath();
  }

  function renderLogoThumb(initials, size = 112, colorPrimary = '#0d2a63'){
    const c = document.createElement('canvas');
    c.width = c.height = size;
    const g = c.getContext('2d');
    const r = Math.round(size * 0.14);
    const bg = g.createLinearGradient(0, 0, size, size);
    bg.addColorStop(0, '#ffffff'); bg.addColorStop(1, '#f3f5ff');
    g.fillStyle = bg; roundRect(g,0,0,size,size,r); g.fill();
    const overlayGrad = g.createLinearGradient(0,0,size,size);
    overlayGrad.addColorStop(0, colorPrimary + '22'); overlayGrad.addColorStop(1, '#ffffff00');
    g.fillStyle = overlayGrad; roundRect(g,0,0,size,size,r); g.fill();
    const fontSize = Math.floor(size * 0.42);
    g.textAlign = 'center'; g.textBaseline = 'middle';
    g.font = `700 ${fontSize}px ${lastRandomStyle && lastRandomStyle.companyFont ? lastRandomStyle.companyFont : 'Poppins'}, sans-serif`;
    g.fillStyle = colorPrimary;
    g.fillText(initials, size/2, size/2);
    return c;
  }

  // ---------------- HD / faux-3D abstract logo generator (offscreen x3) ----------------
  // replaces older simple generator to provide HD, depth, extruded initials and richer shapes.
  function generateAbstractLogoOnCanvas(ctxMain, logoX, logoY, logoSize, style = {}) {
    const SCALE = 3; // high-res multiplier
    const off = document.createElement('canvas');
    off.width = Math.round(logoSize * SCALE);
    off.height = Math.round(logoSize * SCALE);
    const g = off.getContext('2d');

    const w = off.width, h = off.height, cx = w/2, cy = h/2;
    const base = style.companyColor || '#07124b';
    const accent = style.accent2 || '#092042';
    const highlight = style.contactColor || '#10b981';
    const fontName = style.companyFont || '"Archivo Black"';

    // helpers
    function hexToRgb(hex){
      const h = (hex||'#000').replace('#','');
      const vh = h.length===3 ? h.split('').map(c=>c+c).join('') : h;
      const n = parseInt(vh,16);
      return { r:(n>>16)&255, g:(n>>8)&255, b:n&255 };
    }
    function mixHex(a,b,t){
      const A = hexToRgb(a), B = hexToRgb(b||'#fff');
      const r = Math.round(A.r + (B.r - A.r) * t);
      const gcol = Math.round(A.g + (B.g - A.g) * t);
      const bl = Math.round(A.b + (B.b - A.b) * t);
      return `rgb(${r},${gcol},${bl})`;
    }

    g.clearRect(0,0,w,h);

    // rounded background
    const r = Math.round(w * 0.06);
    const bg = g.createLinearGradient(0,0,w,h);
    bg.addColorStop(0, '#ffffff');
    bg.addColorStop(1, mixHex(base, '#ffffff', 0.04));
    g.fillStyle = bg;
    roundRect(g, 0, 0, w, h, r);
    g.fill();

    // soft outer shadow
    g.save();
    g.shadowColor = 'rgba(6,18,40,0.12)';
    g.shadowBlur = Math.round(w * 0.06);
    g.shadowOffsetY = Math.round(w * 0.02);
    g.fillStyle = 'rgba(0,0,0,0)';
    roundRect(g, Math.round(w*0.02), Math.round(w*0.02), w - Math.round(w*0.04), h - Math.round(w*0.04), r);
    g.fill();
    g.restore();

    // layered shapes
    const palette = [ base, accent, highlight ];
    const shapes = 3 + Math.floor(Math.random() * 3);
    for(let i=0;i<shapes;i++){
      const type = ['circle','rect','triangle'][Math.floor(Math.random()*3)];
      const sx = (0.18 + Math.random()*0.64) * w;
      const sy = (0.18 + Math.random()*0.64) * h;
      const s = Math.round(w * (0.18 + Math.random()*0.44));
      const col = palette[Math.floor(Math.random()*palette.length)];
      g.save();
      g.translate(sx, sy);
      g.rotate((Math.random()-0.5) * 0.9);
      g.globalAlpha = 0.75 - Math.random() * 0.35;
      if(type === 'circle'){
        const rg = g.createRadialGradient(0,0,s*0.08,0,0,s);
        rg.addColorStop(0, mixHex(col, '#fff', 0.18));
        rg.addColorStop(1, mixHex(col, '#000', -0.08));
        g.fillStyle = rg;
        g.beginPath(); g.arc(0,0,s/2,0,Math.PI*2); g.fill();
      } else if(type === 'rect'){
        const lg = g.createLinearGradient(-s/2,-s/3,s/2,s/3);
        lg.addColorStop(0, mixHex(col, '#fff', 0.1)); lg.addColorStop(1, mixHex(col, '#000', -0.06));
        g.fillStyle = lg;
        roundRect(g, -s/2, -s/3, s, Math.round(s*0.72), Math.round(s*0.12)); g.fill();
      } else {
        g.fillStyle = mixHex(col, '#fff', 0.06);
        g.beginPath();
        g.moveTo(0, -s/2);
        g.lineTo(s/2, s/2);
        g.lineTo(-s/2, s/2);
        g.closePath();
        g.fill();
      }
      g.restore();
    }

    // gloss
    g.save();
    const gloss = g.createLinearGradient(0, 0, 0, h);
    gloss.addColorStop(0, 'rgba(255,255,255,0.7)');
    gloss.addColorStop(0.25, 'rgba(255,255,255,0.18)');
    gloss.addColorStop(1, 'rgba(255,255,255,0)');
    g.fillStyle = gloss;
    g.beginPath();
    g.ellipse(cx - w*0.06, cy - h*0.28, w*0.62, h*0.36, -0.5, 0, Math.PI*2);
    g.fill();
    g.restore();

    // bevel stroke
    g.save();
    g.lineWidth = Math.max(2, Math.round(w * 0.02));
    const bevel = g.createLinearGradient(0,0,0,h);
    bevel.addColorStop(0, 'rgba(255,255,255,0.85)'); bevel.addColorStop(1, 'rgba(0,0,0,0.06)');
    g.strokeStyle = bevel;
    roundRect(g, Math.round(w*0.06), Math.round(w*0.06), w - Math.round(w*0.12), h - Math.round(w*0.12), Math.round(w*0.06));
    g.stroke();
    g.restore();

    // extruded initials
    const initials = getInitials(companyEl.value || '');
    const txtSize = Math.floor(w * 0.36);
    g.textAlign = 'center';
    g.textBaseline = 'middle';
    g.font = `900 ${txtSize}px ${fontName}`;

    const extrude = Math.max(2, Math.round(w * 0.006));
    for(let i = extrude; i >= 1; i--){
      g.fillStyle = `rgba(0,0,0,${0.04 + (i/extrude)*0.08})`;
      g.fillText(initials, cx + i*0.9, cy + i*0.9);
    }
    const txtGrad = g.createLinearGradient(0, cy - txtSize/2, 0, cy + txtSize/2);
    txtGrad.addColorStop(0, mixHex(base, '#fff', 0.14));
    txtGrad.addColorStop(1, base);
    g.fillStyle = txtGrad;
    g.fillText(initials, cx, cy);

    g.lineWidth = Math.max(1, Math.round(w * 0.008));
    g.strokeStyle = 'rgba(255,255,255,0.6)';
    g.strokeText(initials, cx, cy);

    // tiny specular
    g.save();
    g.globalCompositeOperation = 'lighter';
    g.fillStyle = 'rgba(255,255,255,0.22)';
    g.beginPath();
    g.ellipse(cx + w*0.16, cy - h*0.26, w*0.16, h*0.05, -0.5, 0, Math.PI*2);
    g.fill();
    g.restore();

    // draw offscreen to main canvas with rounded clip
    ctxMain.save();
    const rr = Math.round(logoSize * 0.12);
    roundRect(ctxMain, logoX, logoY, logoSize, logoSize, rr);
    ctxMain.clip();
    ctxMain.drawImage(off, 0, 0, off.width, off.height, logoX, logoY, logoSize, logoSize);
    ctxMain.restore();
  }
  // ----------------------------------------------------------------------------------

  function drawCanvasLogoToMain(ctxMain, logoX, logoY, logoSize, initials, colorPrimary = '#0d2a63'){
    const r = Math.round(logoSize * 0.12);
    const grad = ctxMain.createLinearGradient(logoX, logoY, logoX + logoSize, logoY + logoSize);
    grad.addColorStop(0, '#ffffff'); grad.addColorStop(1, '#f3f5ff');
    ctxMain.fillStyle = grad; roundRect(ctxMain, logoX, logoY, logoSize, logoSize, r); ctxMain.fill();
    ctxMain.save();
    const highlight = ctxMain.createRadialGradient(logoX + logoSize*0.25, logoY + logoSize*0.18, 2, logoX + logoSize*0.25, logoY + logoSize*0.18, logoSize);
    highlight.addColorStop(0, 'rgba(255,255,255,0.9)'); highlight.addColorStop(1, 'rgba(255,255,255,0)');
    ctxMain.fillStyle = highlight; roundRect(ctxMain, logoX, logoY, logoSize, logoSize, r); ctxMain.fill(); ctxMain.restore();
    const fontSize = Math.floor(logoSize * 0.42);
    ctxMain.textAlign = 'center'; ctxMain.textBaseline = 'middle';
    ctxMain.font = `700 ${fontSize}px ${lastRandomStyle && lastRandomStyle.companyFont ? lastRandomStyle.companyFont : 'Poppins'}, sans-serif`;
    for(let i=6;i>=1;i--){ ctxMain.fillStyle = `rgba(0,0,0,${0.02 * i})`; ctxMain.fillText(initials, logoX + logoSize/2 + i*1.2, logoY + logoSize/2 + i*1.2); }
    ctxMain.fillStyle = colorPrimary; ctxMain.fillText(initials, logoX + logoSize/2, logoY + logoSize/2);
    ctxMain.lineWidth = Math.max(1, Math.round(logoSize * 0.03));
    ctxMain.strokeStyle = 'rgba(255,255,255,0.12)'; ctxMain.strokeText(initials, logoX + logoSize/2, logoY + logoSize/2);
  }

  // upload (thumbnail preview only)
  logoFile.addEventListener('change', async (e) => {
    const f = e.target.files?.[0];
    if(!f) return;
    currentLogoDataUrl = await fileToDataUrl(f);
    logoPreview.innerHTML = '';
    const img = document.createElement('img'); img.src = currentLogoDataUrl; img.alt='logo';
    img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover';
    logoPreview.appendChild(img);
    // update review usage text if on review panel
    revUseUploaded.textContent = 'Using uploaded for final: ' + ((useUploadedIf && useUploadedIf.checked && currentLogoDataUrl) ? 'Yes' : 'No');
  });
  logoFile.addEventListener('input', (e) => {
    if(!e.target.files || e.target.files.length === 0){
      currentLogoDataUrl = null; updateLogoInitials();
      revUseUploaded.textContent = 'Using uploaded for final: ' + ((useUploadedIf && useUploadedIf.checked && currentLogoDataUrl) ? 'Yes' : 'No');
    }
  });

  // toggle checkbox update review status
  if(useUploadedIf){
    useUploadedIf.addEventListener('change', ()=> {
      revUseUploaded.textContent = 'Using uploaded for final: ' + ((useUploadedIf.checked && currentLogoDataUrl) ? 'Yes' : 'No');
    });
  }

  function updateLogoInitials(){
    // Only update thumbnail if there's no upload
    if(currentLogoDataUrl) return;
    const initials = getInitials(companyEl.value || '');
    logoPreview.innerHTML = '';
    const colorPrimary = lastRandomStyle && lastRandomStyle.companyColor ? lastRandomStyle.companyColor : '#0d2a63';
    const thumb = renderLogoThumb(initials, 112, colorPrimary);
    logoPreview.appendChild(thumb);
  }

  // helpers
  function wrapText(ctxLocal,text,maxWidth){
    const words = (text||'').split(/\s+/); const lines=[]; let line='';
    for(let w of words){
      const test = line ? (line + ' ' + w) : w;
      if(ctxLocal.measureText(test).width > maxWidth && line){ lines.push(line); line = w; } else line = test;
    }
    if(line) lines.push(line); return lines;
  }
  function fileToDataUrl(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }
  async function ensureFonts(){
    const fontsToLoad = ['"Archivo Black"', 'Anton', '"Bebas Neue"', '"Montserrat"', 'Rubik', '"Poppins"'];
    try{
      await Promise.all(fontsToLoad.map(f => document.fonts.load(`700 48px ${f}`)));
      await document.fonts.ready;
      return true;
    }catch(e){
      await document.fonts.ready;
      return false;
    }
  }
  function escapeXml(s){ return (s||'').replace(/[<>&'"]/g,c=>({'<':'&lt;','>':'&gt;','&':'&amp;',"'":'&apos;','\"':'&quot;'}[c])); }
  function getInitials(name){ if(!name) return 'ASD'; const parts = name.trim().split(/\s+/).filter(Boolean); if(parts.length===1) return parts[0].slice(0,3).toUpperCase(); return (parts[0][0]+(parts[1][0]||'')).toUpperCase(); }

  // dotted
  function drawDotted(ctxLocal,x,y,w){ ctxLocal.save(); ctxLocal.strokeStyle='#c7c7c7'; ctxLocal.setLineDash([2,6]); ctxLocal.beginPath(); ctxLocal.moveTo(x,y); ctxLocal.lineTo(x+w,y); ctxLocal.stroke(); ctxLocal.setLineDash([]); ctxLocal.restore(); }

  // demo watermark
  function drawDemoWatermarksOnCanvas(){
    ctx.save();
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    const fillOpacity = 0.28;
    const strokeOpacity = 0.6;
    ctx.fillStyle = `rgba(128,0,0,${fillOpacity})`;
    ctx.strokeStyle = `rgba(128,0,0,${strokeOpacity})`;
    ctx.lineWidth = Math.max(2, Math.round(canvas.width * 0.002));
    const fontSize = Math.round(canvas.width * 0.06);
    ctx.font = `900 ${fontSize}px 'Archivo Black', Arial, sans-serif`;
    const positions = [
      {x: canvas.width*0.18, y: canvas.height*0.12, angle: -22},
      {x: canvas.width*0.52, y: canvas.height*0.20, angle: -16},
      {x: canvas.width*0.78, y: canvas.height*0.10, angle: -24},
      {x: canvas.width*0.32, y: canvas.height*0.48, angle: -18},
      {x: canvas.width*0.62, y: canvas.height*0.68, angle: -20},
    ];
    positions.forEach(p=>{
      ctx.save();
      ctx.translate(p.x, p.y);
      ctx.rotate(p.angle * Math.PI / 180);
      ctx.fillText('PRE DEMO ONLY', 0, 0);
      ctx.strokeText('PRE DEMO ONLY', 0, 0);
      ctx.restore();
    });
    ctx.restore();
  }

  // Helper: preview banner
  function showPreviewBanner(msg, type='warn'){
    previewBanner.className = 'preview-banner ' + (type==='warn' ? 'warn' : 'info');
    previewBanner.innerHTML = `<div>${msg}</div><div><a class="deposit-cta" href="deposit.html">Add Fund</a></div>`;
    previewBanner.classList.remove('hidden');
  }
  function clearPreviewBanner(){ previewBanner.className = 'preview-banner hidden'; previewBanner.innerHTML = ''; }

  function pickRandom(arr){ if(!arr || arr.length===0) return null; return arr[Math.floor(Math.random() * arr.length)]; }

  // draw letterhead - now supports using uploaded logo if checkbox enabled
  async function drawLetterheadToCanvas(data){
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    const margin = Math.round(canvas.width * 20 / 595);
    const headerH = Math.round(canvas.height * 0.14);
    const logoSize = Math.round(headerH * 0.6);
    const gap = Math.round(logoSize * 0.18);
    const leftX = margin, rightX = canvas.width - margin, topY = margin;
    const logoX = leftX, logoY = topY;
    const r = Math.round(logoSize * 0.12);

    const style = data.randomStyle || lastRandomStyle || {};
    const companyFontFam = style.companyFont ? style.companyFont : '"Archivo Black"';
    const natureFontFam = style.natureFont ? style.natureFont : '"Times New Roman"';
    const companyColor = style.companyColor || '#07124b';
    const natureColor = style.natureColor || '#b91c1c';
    const contactColor = style.contactColor || 'rgba(55,65,81,0.94)';
    const phoneColor = style.phoneColor || '#b91c1c';
    const accent1 = style.accent1 || '#0d2a63';
    const accent2 = style.accent2 || '#092042';

    // Decide whether to use uploaded image or generated abstract logo
    const wantUploaded = (useUploadedIf && useUploadedIf.checked && data.logoDataUrl);
    if(wantUploaded){
      // Draw uploaded logo into rounded box
      try{
        const img = await loadImage(data.logoDataUrl);
        ctx.save();
        roundRect(ctx, logoX, logoY, logoSize, logoSize, r);
        ctx.clip();
        // fit image covering the square, preserve aspect by scaling up
        const scale = Math.max(logoSize / img.width, logoSize / img.height);
        const iw = img.width * scale, ih = img.height * scale;
        ctx.drawImage(img, logoX + (logoSize - iw)/2, logoY + (logoSize - ih)/2, iw, ih);
        ctx.restore();
      }catch(e){
        console.warn('logo draw failed, falling back to generated', e);
        generateAbstractLogoOnCanvas(ctx, logoX, logoY, logoSize, style);
      }
    } else {
      // generate random HD/3D style logo
      generateAbstractLogoOnCanvas(ctx, logoX, logoY, logoSize, style);
    }

    // company / nature / address left
    const baselineWidth = 595;
    const s = canvas.width / baselineWidth;
    let companySize = Math.round(20 * s);
    let natureSize  = Math.round(16 * s);
    if((data.company || '').length > 28) companySize = Math.round(12 * s);
    if((data.nature || '').length > 33) natureSize = Math.round(12 * s);
    const phoneSize = Math.round(15 * s);
    const addrSize  = Math.round(14 * s);

    const companyX = logoX + logoSize + gap;
    const companyY = logoY + Math.round(logoSize * 0.06);
    ctx.textBaseline = 'top';
    ctx.textAlign = 'left';
    // company name: heavy font + chosen color
    ctx.font = `${companySize}px ${companyFontFam}`;
    ctx.fillStyle = companyColor;
    ctx.fillText((data.company||'').toUpperCase(), companyX, companyY);

    let afterLeftY = companyY + companySize;
    if(data.nature){
      const natY = afterLeftY + Math.round(companySize * 0.08);
      // nature: italic + bold + red
      ctx.font = `italic bold ${natureSize}px ${natureFontFam}`;
      ctx.fillStyle = natureColor || '#b91c1c';
      ctx.fillText(data.nature, companyX, natY);
      afterLeftY = natY + Math.round(natureSize * 1.2);
      if(data.address){
        ctx.font = `${addrSize}px Arial, Helvetica, sans-serif`;
        ctx.fillStyle = contactColor;
        const lines = wrapText(ctx, data.address, Math.round(canvas.width * 0.45));
        let ay = afterLeftY + Math.round(addrSize * 0.3);
        lines.forEach(line => { ctx.fillText(line, companyX, ay); ay += Math.round(addrSize * 1.3); });
        afterLeftY = ay;
      }
    } else {
      if(data.address){
        ctx.font = `${addrSize}px Arial, Helvetica, sans-serif`;
        ctx.fillStyle = contactColor;
        const lines = wrapText(ctx, data.address, Math.round(canvas.width * 0.45));
        let ay = afterLeftY + Math.round(addrSize * 0.3);
        lines.forEach(line => { ctx.fillText(line, companyX, ay); ay += Math.round(addrSize * 1.3); });
      }
    }

    // right top: phone/email
    let contactX = rightX - Math.round(canvas.width * 0.24);
    let contactY = topY + Math.round(logoSize * 0.06);
    if(data.phone){
      ctx.font = `bold ${phoneSize}px Arial, Helvetica, sans-serif`;
      ctx.fillStyle = phoneColor;
      ctx.fillText(data.phone, contactX, contactY);
      contactY += Math.round(phoneSize * 1.4);
    }
    if(data.email){
      ctx.font = `${addrSize}px Arial, Helvetica, sans-serif`; ctx.fillStyle = contactColor; ctx.fillText(data.email, contactX, contactY); contactY += Math.round(addrSize * 1.3);
    }

    // accent bar
    const barY = logoY + logoSize + Math.round(logoSize * 0.12);
    const barH = Math.max(6, Math.round(canvas.height * 0.006));
    const grad = ctx.createLinearGradient(margin, barY, canvas.width - margin, barY);
    grad.addColorStop(0, accent1); grad.addColorStop(1, accent2);
    ctx.fillStyle = grad; ctx.fillRect(margin, barY, canvas.width - margin*2, barH);

    const refsY = barY + barH + Math.round(canvas.height * 0.02);
    ctx.font = `${Math.round(12 * s)}px Arial, Helvetica, sans-serif`;
    ctx.fillStyle = 'rgba(107,114,128,1)';
    ctx.fillText('Our Ref:............................................    Your Ref......................................    Date.........................................', margin, refsY);
    drawDotted(ctx, margin + Math.round(canvas.width * 0.12), refsY + Math.round(12 * s * 0.28), Math.round(canvas.width * 0.28));
  }

  function loadImage(src){ return new Promise((res,rej)=>{ const img=new Image(); img.onload=()=>res(img); img.onerror=e=>rej(e); img.crossOrigin='anonymous'; img.src=src; }); }

  // Balance/demo logic
  const MIN_COST = 200;
  async function incrementDemoCount(){
    const demoRef = ref(db, `users/${uid}/demoCount`);
    try{
      const tx = await runTransaction(demoRef, (c)=> ( (c||0) + 1 ), {applyLocally:false});
      const val = tx.snapshot && tx.snapshot.val() ? tx.snapshot.val() : tx.snapshot.val();
      return Number(val || 0);
    }catch(e){
      console.error('Failed to increment demoCount', e);
      return null;
    }
  }
  function insertTransactionRecord(obj){
    try{
      const txRef = ref(db, `users/${uid}/transactions`);
      set(push(txRef), obj).catch(e=>console.error('log trx failed', e));
    }catch(e){}
  }
  function showLockedOverlayOnPreview(message){
    // remove any prior overlay then show a lock overlay (blank preview)
    clearLockedOverlay();
    const ov = document.createElement('div');
    ov.className = 'locked-overlay';
    ov.innerHTML = `<div style="text-align:center">
      <div style="font-weight:800;color:#b91c1c">Preview blocked</div>
      <div style="margin-top:6px;color:#374151">${message}</div>
      <a class="deposit-cta" href="deposit.html">Add Fund</a>
    </div>`;
    previewBox.appendChild(ov);
    // hide preview image to make it blank
    previewImage.style.display = 'none';
  }
  function clearLockedOverlay(){ const ov = previewBox.querySelector('.locked-overlay'); if(ov) ov.remove(); previewBox.style.pointerEvents='auto'; }

  // Generate flow
  document.getElementById('generateNow').addEventListener('click', async () => {
    if(!validatePanel(panels.find(p=>Number(p.dataset.step)===1))){
      showToast('Please complete required fields before generating.');
      return;
    }

    // randomize company font + company color from requested list
    try{
      const companyFont = pickRandom(BOLD_COMPANY_FONTS);
      const companyColor = pickRandom(COMPANY_COLORS);
      const accentSecondary = '#092042';
      const natureFont = pickRandom(NATURE_FONTS);
      lastRandomStyle = {
        companyFont: companyFont,
        natureFont: natureFont,
        companyColor: companyColor,
        natureColor: '#b91c1c',
        contactColor: '#374151',
        phoneColor: '#b91c1c',
        accent1: companyColor,
        accent2: accentSecondary
      };
    }catch(e){
      lastRandomStyle = null;
      console.warn('random style failed', e);
    }

    // ensure preview thumbnail updated
    updateLogoInitials();
    previewColumn.style.display = 'flex';
    overlay.classList.add('show');
    previewBox.classList.add('processing');
    previewImage.style.display = 'none';
    clearPreviewBanner();
    clearLockedOverlay();

    try{ setTimeout(()=> previewColumn.scrollIntoView({ behavior: 'smooth', block: 'center' }), 150); }catch(e){}

    // progress
    const PROCESS_MS = 1200;
    const start = Date.now();
    progressFill.style.width = '0%'; progressText.textContent = '0%';
    progressSpinner.style.display = 'inline-block';
    const tick = 60;
    let intervalId = setInterval(() => {
      const elapsed = Date.now() - start;
      const pct = Math.min(100, Math.round((elapsed / PROCESS_MS) * 100));
      progressFill.style.width = pct + '%'; progressText.textContent = pct + '%';
      if(pct >= 100) clearInterval(intervalId);
    }, tick);
    await new Promise(res => setTimeout(res, PROCESS_MS));

    try{
      await ensureFonts();
      // draw letterhead to canvas passing lastRandomStyle (drawLetterheadToCanvas will decide uploaded vs generated)
      await drawLetterheadToCanvas({
        company: companyEl.value.trim(),
        nature: natureEl.value.trim(),
        email: emailEl.value.trim(),
        address: addressEl.value.trim(),
        phone: phoneEl.value.trim(),
        logoDataUrl: currentLogoDataUrl,
        randomStyle: lastRandomStyle
      });

      // Attempt atomic deduction
      try{
        const balanceRef = ref(db, `users/${uid}/balance`);
        const txResult = await runTransaction(balanceRef, (current)=>{
          if (current === null) return current;
          if (Number(current) >= MIN_COST) return Number(current) - MIN_COST;
          return;
        }, {applyLocally:false});

        if (txResult.committed && txResult.snapshot){
          // success: funds deducted
          generatedOk = true;
          const scale = 0.28;
          const tmp = document.createElement('canvas');
          tmp.width = Math.round(canvas.width * scale);
          tmp.height = Math.round(canvas.height * scale);
          const tctx = tmp.getContext('2d');
          tctx.fillStyle = '#ffffff'; tctx.fillRect(0,0,tmp.width,tmp.height);
          tctx.drawImage(canvas,0,0,tmp.width,tmp.height);
          previewImage.src = tmp.toDataURL('image/png');
          previewImage.style.display = 'block';
          downloadPngBtn.disabled = false; downloadPdfBtn.disabled = false;
          showPreviewBanner('Generated — ₦200 deducted. Downloads enabled.', 'info');
          showToast('Successfully deducted ₦200.', { type: 'success', timeout: 3500 });
          insertTransactionRecord({
            type: 'debit', action: 'generate', amount: MIN_COST,
            company: companyEl.value.trim(), timestamp: Date.now(), status:'success'
          });
        } else {
          // insufficient: demo behaviour (allow up to DEMO_LIMIT watermarked previews)
          const newDemoCount = await incrementDemoCount();
          if(newDemoCount === null){
            generatedOk = false; downloadPngBtn.disabled = true; downloadPdfBtn.disabled = true;
            drawDemoWatermarksOnCanvas();
            const scale = 0.28; const tmp = document.createElement('canvas');
            tmp.width = Math.round(canvas.width * scale); tmp.height = Math.round(canvas.height * scale);
            const tctx = tmp.getContext('2d');
            tctx.fillStyle = '#ffffff'; tctx.fillRect(0,0,tmp.width,tmp.height);
            tctx.drawImage(canvas,0,0,tmp.width,tmp.height);
            previewImage.src = tmp.toDataURL('image/png'); previewImage.style.display = 'block';
            showLockedOverlayOnPreview('Could not verify demo allowance. Please add funds to continue.');
            showPreviewBanner('Could not verify demo allowance. Add fund to remove block.');
            insertTransactionRecord({ type:'debit', action:'generate', amount:0, status:'insufficient_unknown', timestamp:Date.now() });
          } else if(newDemoCount <= DEMO_LIMIT){
            // show watermarked preview (demo)
            generatedOk = false;
            drawDemoWatermarksOnCanvas();
            const scale = 0.28; const tmp = document.createElement('canvas');
            tmp.width = Math.round(canvas.width * scale); tmp.height = Math.round(canvas.height * scale);
            const tctx = tmp.getContext('2d');
            tctx.fillStyle = '#ffffff'; tctx.fillRect(0,0,tmp.width,tmp.height);
            tctx.drawImage(canvas,0,0,tmp.width,tmp.height);
            previewImage.src = tmp.toDataURL('image/png'); previewImage.style.display = 'block';
            downloadPngBtn.disabled = true; downloadPdfBtn.disabled = true;
            showPreviewBanner(`Demo preview shown (${newDemoCount}/${DEMO_LIMIT}) — Add ₦${MIN_COST} to remove watermark.`);
            insertTransactionRecord({ type:'debit', action:'generate', amount:0, status:'demo_shown', demoCount:newDemoCount, timestamp:Date.now() });
          } else {
            // demo limit exceeded: block preview (blank) and show deposit CTA
            generatedOk = false;
            downloadPngBtn.disabled = true; downloadPdfBtn.disabled = true;
            showLockedOverlayOnPreview(`Demo limit reached (${newDemoCount}). You had ${DEMO_LIMIT} demo previews. Add ₦${MIN_COST} to remove block.`);
            showPreviewBanner(`Demo limit reached (${newDemoCount}). Add ₦${MIN_COST} to remove block.`);
            insertTransactionRecord({ type:'debit', action:'generate', amount:0, status:'demo_blocked', demoCount:newDemoCount, timestamp:Date.now() });
          }
        }
      }catch(txErr){
        console.error('Transaction error', txErr);
        generatedOk = false; downloadPngBtn.disabled = true; downloadPdfBtn.disabled = true;
        drawDemoWatermarksOnCanvas();
        const scale = 0.28; const tmp = document.createElement('canvas');
        tmp.width = Math.round(canvas.width * scale); tmp.height = Math.round(canvas.height * scale);
        const tctx = tmp.getContext('2d');
        tctx.fillStyle = '#ffffff'; tctx.fillRect(0,0,tmp.width,tmp.height);
        tctx.drawImage(canvas,0,0,tmp.width,tmp.height);
        previewImage.src = tmp.toDataURL('image/png'); previewImage.style.display = 'block';
        showLockedOverlayOnPreview('Could not check/update balance. Add fund to continue.');
        showPreviewBanner('Could not check/update balance (check connection). Add fund to remove watermark.');
        insertTransactionRecord({ type:'debit', action:'generate', amount:0, status:'error', error:String(txErr) , timestamp:Date.now() });
      }
    }catch(err){
      console.error('Generate error', err);
      showToast('An error occurred during generation. Check console for details.');
    } finally {
      setTimeout(()=> {
        overlay.classList.remove('show');
        previewBox.classList.remove('processing');
        progressSpinner.style.display = 'none';
      }, 350);
    }
  });

  // downloads
  downloadPngBtn.addEventListener('click', () => {
    if(!generatedOk){ showToast('Generate with sufficient balance before downloading.'); return; }
    canvas.toBlob(blob => {
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url;
      const name = (companyEl.value.trim() ? companyEl.value.trim().replace(/\s+/g,'_') : 'letterhead') + '.png';
      a.download = name; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    }, 'image/png');
  });

  downloadPdfBtn.addEventListener('click', async () => {
    if(!generatedOk){ showToast('Generate with sufficient balance before downloading.'); return; }
    const imgData = canvas.toDataURL('image/png');
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p','mm','a4');
    const margin = 6;
    const pdfW = 210 - margin*2;
    const pdfH = (canvas.height / canvas.width) * pdfW;
    const x = margin;
    const y = margin + ((297 - margin*2 - pdfH)/2);
    doc.addImage(imgData, 'PNG', x, y, pdfW, pdfH);
    const filename = (companyEl.value.trim() ? companyEl.value.trim().replace(/\s+/g,'_') : 'letterhead') + '.pdf';
    doc.save(filename);
  });

</script>
</body>
</html>