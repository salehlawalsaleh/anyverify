<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NIN Slip Generator ‚Äî AmeerTech (Multi-Step)</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.css">

<style>
  :root{
    --bg:#f4f6f8; --card:#fff; --ink:#0f172a; --muted:#64748b; --brand:#0ea5a0; --brand-2:#007f5f;
    --ring:#0ea5a0; --danger:#ef4444;
  }
  *{box-sizing:border-box}
  body{font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background:var(--bg); margin:0; padding:24px; color:var(--ink)}
  .container{max-width:1100px; margin:auto}
  .card{background:var(--card); border-radius:16px; box-shadow:0 10px 30px rgba(2,8,23,0.08); overflow:hidden}
  .header{padding:20px 24px; border-bottom:1px solid #e5e7eb; display:flex; align-items:center; justify-content:space-between; gap:12px}
  .title{margin:0; font-weight:800; letter-spacing:-0.02em}
  .steps{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  .step{display:flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-weight:600; font-size:13px; color:var(--muted); background:#f1f5f9}
  .step.active{color:#0b3b35; background:#d1fae5}
  .step .dot{width:22px; height:22px; border-radius:50%; display:grid; place-items:center; font-size:12px; font-weight:800; background:white; border:2px solid #94a3b8}
  .step.active .dot{border-color:var(--brand-2); color:var(--brand-2)}
  .body{padding:24px}
  .grid{display:grid; gap:16px; grid-template-columns:repeat(auto-fit, minmax(220px,1fr))}
  label{font-size:13px; font-weight:700; color:#0f172a; display:block; margin-bottom:6px}
  input[type="text"], input[type="date"], select, input[type="number"], input[type="time"], input[type="email"], input[type="password"]{width:100%; padding:12px 12px; border:1px solid #e2e8f0; border-radius:12px; background:white; outline:none; transition:box-shadow .2s,border-color .2s}
  input:focus, select:focus{border-color:var(--ring); box-shadow:0 0 0 4px rgba(14,165,160,.15)}
  .actions{display:flex; gap:12px; flex-wrap:wrap; margin-top:8px}
  button{border:none; border-radius:12px; padding:12px 16px; font-weight:800; cursor:pointer}
  .btn-primary{background:linear-gradient(135deg, var(--brand-2), var(--brand)); color:white}
  .btn-ghost{background:#e2e8f0; color:#0f172a}
  .btn-outline{background:transparent; color:var(--brand-2); border:2px solid var(--brand-2)}
  .btn-disabled{opacity:.5; pointer-events:none}
  .muted{color:var(--muted); font-size:13px}
  .hidden{display:none !important}
  .error{color:var(--danger); font-weight:700; grid-column:1 / -1}
  .upload-zone{border:2px dashed #cbd5e1; border-radius:16px; padding:14px; display:grid; gap:12px; background:#f8fafc}
  .cropper-wrapper{width:100%; max-height:400px; overflow:hidden; border-radius:14px; background:#000}
  .preview-wrap{margin-top:18px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:14px; padding:14px; position:relative}
  canvas#preview{width:100%; max-width:100%; height:auto; border-radius:12px; background:#f1f5f9; display:block}

  .processing-blur{filter:blur(6px)}
  .processing-overlay{
    position:absolute; inset:14px; display:grid; place-items:center;
    background:rgba(255,255,255,0.5); border-radius:12px; pointer-events:none;
  }
  .spinner-mini{
    width:56px; height:56px; border-radius:50%;
    border:6px solid rgba(14,165,160,0.25); border-top-color:#0ea5a0; animation:spin 1s linear infinite;
  }
  @keyframes spin{to{transform:rotate(360deg)}}

  /* locked demo (after 2 demo views) */
  .locked-blur{filter:blur(8px); pointer-events:none; opacity:0.9}
  .locked-overlay{
    position:absolute; inset:14px; display:flex; align-items:center; justify-content:center; border-radius:12px;
    background:rgba(255,255,255,0.85); z-index:40; flex-direction:column; gap:12px;
  }

  .footnote{font-size:12px; color:#475569}

  /* Toast */
  .toast-wrap{position:fixed; left:50%; transform:translateX(-50%); bottom:28px; z-index:9999; display:grid; gap:10px; align-items:end}
  .toast{min-width:220px; max-width:90vw; padding:12px 16px; border-radius:12px; background:#0b3b35; color:#fff; box-shadow:0 10px 30px rgba(2,8,23,0.12); font-weight:700; opacity:0; transform:translateY(8px); transition:all .28s ease}
  .toast.show{opacity:1; transform:translateY(0)}
  .toast.info{background:linear-gradient(135deg,#0ea5a0,#007f5f)}
  .toast.warn{background:#ef4444}

  .deposit-cta{display:inline-block;margin-left:10px;padding:6px 10px;border-radius:8px;background:#0ea5a0;color:#fff;font-weight:800;cursor:pointer;text-decoration:none}

  /* Preview banner */
  .preview-banner{margin-top:12px;padding:10px;border-radius:8px;display:flex;align-items:center;justify-content:space-between;gap:10px;font-weight:700}
  .preview-banner.warn{background:#fff7f6;color:#9b1c1c;border:1px solid #fecaca}
  .preview-banner.info{background:#ecfdf5;color:#065f46;border:1px solid #bbf7d0}

  /* Block overlay (full white) */
  .block-overlay{
    position:fixed; inset:0; background:white; z-index:999999; display:flex; align-items:center; justify-content:center; padding:24px; text-align:center;
  }
  .block-box{max-width:760px}
  .block-box h1{color:#b91c1c; margin:0 0 12px}
  .block-box p{color:#374151; margin:0 0 8px}
  .block-btn{display:inline-block;margin-top:12px;padding:10px 16px;border-radius:10px;background:#0ea5a0;color:#fff;text-decoration:none;font-weight:700}

  @media print {
    @page { size: A4; margin: 10mm; }
    body * { visibility: hidden; }
    canvas#preview, canvas#preview * { visibility: visible; }
    canvas#preview { position: absolute; left: 0; top: 0; width: auto; height: auto; }
  }
</style>
</head>
<body>
<div class="container">
  <div class="card">
    <div class="header">
      <h2 class="title">NIN Slip Generator</h2>
      <div class="steps" id="stepsBar">
        <div class="step active" data-step="1"><span class="dot">1</span> Step 1</div>
        <div class="step" data-step="2"><span class="dot">2</span> Step 2</div>
        <div class="step" data-step="3"><span class="dot">3</span> Step 3</div>
      </div>
    </div>

    <div class="body">
      <!-- STEP 1 -->
      <form id="step1" class="grid">
        <div><label>First Name *</label><input id="firstName" type="text" required placeholder="e.g. Ameer"></div>
        <div><label>Second Name (Surname) *</label><input id="secondName" type="text" required placeholder="e.g. Lawal"></div>
        <div><label>Middle Name</label><input id="middleName" type="text" placeholder="optional"></div>
        <div class="actions" style="grid-column:1/-1">
          <button type="button" class="btn-primary" id="toStep2">Next ‚Üí</button>
          <button type="button" class="btn-ghost" id="backToMain1">‚Üê Main</button>
          <span class="muted">Fill required fields to continue.</span>
        </div>
      </form>

      <!-- STEP 2 -->
      <form id="step2" class="grid hidden">
        <div><label>Date of Birth *</label><input id="dob" type="date" required></div>
        <div><label>Sex *</label>
          <select id="sex" required><option value="">Select</option><option>Male</option><option>Female</option></select>
        </div>
        <div><label>NIN (11 digits) *</label>
          <input id="nin" type="text" maxlength="11" inputmode="numeric" pattern="\d{11}" required placeholder="XXXXXXXXXXX">
        </div>
        <div id="msg2" class="error hidden">NIN dole ya zama lamba 11 kawai.</div>
        <div class="actions" style="grid-column:1/-1">
          <button type="button" class="btn-ghost" id="back1">‚Üê Back</button>
          <button type="button" class="btn-primary" id="toStep3">Next ‚Üí</button>
          <button type="button" class="btn-ghost" id="backToMain2">‚Üê Main</button>
        </div>
      </form>

      <!-- STEP 3 -->
      <form id="step3" class="grid hidden">
        <div class="upload-zone" style="grid-column:1/-1">
          <div class="muted"><strong>Passport Photo *</strong> ‚Äî Upload and crop before generating.</div>
          <input id="passport" type="file" accept="image/*">
          <div class="cropper-wrapper hidden" id="cropperWrap">
            <img id="cropImg" alt="Crop preview">
          </div>
          <div class="actions" id="cropControls">
            <button type="button" id="fitCrop" class="btn-outline hidden">Fit</button>
            <button type="button" id="resetCrop" class="btn-outline hidden">Reset</button>
            <button type="button" id="confirmCrop" class="btn-primary hidden">OK</button>
          </div>
        </div>

        <label style="grid-column:1/-1; display:flex; gap:10px; align-items:flex-start">
          <input type="checkbox" id="agree">
          <span class="muted">By clicking <b>Generate</b>, you agree to our <a href="#" id="tcLink">terms and conditions</a>.</span>
        </label>

        <div id="msg3" class="error hidden" style="grid-column:1/-1"></div>

        <div class="actions" style="grid-column:1/-1">
          <button type="button" class="btn-ghost" id="back2">‚Üê Back</button>
          <button type="button" class="btn-primary btn-disabled" id="generateBtn" disabled>Generate</button>
          <button type="button" class="btn-ghost" id="backToMain3">‚Üê Main</button>
        </div>

        <!-- Preview -->
        <div id="previewWrap" class="preview-wrap hidden" style="grid-column:1/-1; position:relative;">
          <div class="muted" style="margin-bottom:8px">Preview</div>
          <canvas id="preview" width="1224" height="1584"></canvas>

          <!-- locked overlay (inserted dynamically) -->

          <div id="previewBanner" class="preview-banner hidden"></div>

          <div class="actions" style="margin-top:12px">
            <button type="button" class="btn-primary" id="downloadBtn">Print Slip</button>
            <button type="button" class="btn-outline" id="downloadPngBtn">Download PNG</button>
          </div>
          <div class="footnote">Make sure all details are correct before printing.</div>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Toast wrapper -->
<div class="toast-wrap" id="toastWrap"></div>

<script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getDatabase, ref, get, runTransaction, push, set, update
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  /* ======= CONFIG & INIT ======= */
  const firebaseConfig = {
    apiKey: "AIzaSyDc0bIipHU7N73mju33dNwSWmH3IeIYkog",
    authDomain: "ameernin-ba310.firebaseapp.com",
    databaseURL: "https://ameernin-ba310-default-rtdb.firebaseio.com",
    projectId: "ameernin-ba310",
    storageBucket: "ameernin-ba310.appspot.com",
    messagingSenderId: "522206845073",
    appId: "1:522206845073:web:3c85714bd7eda6c1048730",
  };
  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);
  const auth = getAuth(app);

  /* ======= Toast util ======= */
  const toastWrap = document.getElementById('toastWrap');
  function showToast(msg, type='info', duration=4000, actionsHtml=null){
    const t = document.createElement('div');
    t.className = 'toast show ' + (type==='warn'?'warn':(type==='info'?'info':''));
    t.innerHTML = `<div style="display:flex;gap:10px;align-items:center;justify-content:space-between"><div>${msg}</div>${actionsHtml||''}</div>`;
    toastWrap.appendChild(t);
    setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(),300); }, duration);
    return t;
  }

  /* ======= Auth state (use Firebase Auth instead of localStorage) ======= */
  // uid will be set when user is authenticated
  let uid = null;

  // onAuthStateChanged handles redirect when not signed in, and initializes page when user exists
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      try{ localStorage.removeItem('currentUserId'); }catch(e){}
      window.location.href = 'auth.html';
      return;
    }

    uid = user.uid;
    try{ localStorage.setItem('currentUserId', uid); }catch(e){}

    // init and blocked-check (same logic you had before)
    try{
      const userSnap = await get(ref(db, `users/${uid}`));
      if(!userSnap.exists()){
        localStorage.clear();
        window.location.href = 'auth.html';
        return;
      }
      const userObj = userSnap.val();

      if(userObj.status === 'blocked' || userObj.blocked === true){
        try{ await update(ref(db, `users/${uid}`), { status: 'blocked' }); }catch(e){}
        localStorage.clear();
        document.body.innerHTML = `
          <div class="block-overlay" role="alert">
            <div class="block-box">
              <h1>üö´ Your account was blocked</h1>
              <p>Your account has been blocked. Contact support if you think this is a mistake:</p>
              <p><a href="https://wa.me/2348145415083" target="_blank">wa.me/2348145415083</a></p>
              <p style="margin-top:12px;color:#6b7280">Powered by: Atech ICT team</p>
              <a class="block-btn" href="auth.html">Return to login</a>
            </div>
          </div>
        `;
        return; // stop initialization
      }

      // set local balance (optional)
      try{ localStorage.setItem('balance', (userObj.balance || 0)); }catch(e){}
    }catch(err){
      console.error('Initialization error', err);
      localStorage.clear();
      window.location.href = 'auth.html';
      return;
    }

    // proceed with page logic now that uid is available
    main();
  });

  /* ======= The rest of script (wrapped to run after blocked-check) ======= */
  function main(){
    /* ======= Step wiring ======= */
    const stepEls = [...document.querySelectorAll('.step')];
    const s1 = document.getElementById('step1');
    const s2 = document.getElementById('step2');
    const s3 = document.getElementById('step3');
    function setStep(n){
      [s1,s2,s3].forEach((el,i)=>el.classList.toggle('hidden', i!==n-1));
      stepEls.forEach(el => el.classList.toggle('active', +el.dataset.step === n));
      stepEls.forEach(el => el.style.opacity = (+el.dataset.step === n) ? '1' : '0.35');
      window.scrollTo({top:0, behavior:'smooth'});
    }
    document.getElementById('toStep2').onclick = () => {
      const firstName = document.getElementById('firstName').value.trim();
      const secondName = document.getElementById('secondName').value.trim();
      if(!firstName || !secondName){ showToast('Please fill First & Surname.', 'warn'); return; }
      setStep(2);
    };
    document.getElementById('toStep3').onclick = () => {
      const nin = document.getElementById('nin').value.trim();
      const msg2 = document.getElementById('msg2');
      if(!/^[0-9]{11}$/.test(nin)){ msg2.classList.remove('hidden'); return; } else msg2.classList.add('hidden');
      setStep(3);
    };
    document.getElementById('back1').onclick = () => setStep(1);
    document.getElementById('back2').onclick = () => setStep(2);
    ['backToMain1','backToMain2','backToMain3'].forEach(id=>{
      const el = document.getElementById(id);
      if(el) el.onclick = ()=> { window.location.href = 'dashboard.html'; };
    });

    /* ======= Agree gating ======= */
    const agree = document.getElementById('agree');
    const generateBtn = document.getElementById('generateBtn');
    agree.addEventListener('change', ()=>{
      generateBtn.disabled = !agree.checked;
      generateBtn.classList.toggle('btn-disabled', !agree.checked);
    });

    /* ======= Cropper bits ======= */
    let cropper=null, cropConfirmed=false, passportImageBlob=null, confirmedPassportImg=null;
    const passportInput = document.getElementById('passport');
    const cropperWrap = document.getElementById('cropperWrap');
    const cropImg = document.getElementById('cropImg');
    const fitCrop = document.getElementById('fitCrop');
    const resetCrop = document.getElementById('resetCrop');
    const confirmCrop = document.getElementById('confirmCrop');

    if (passportInput) {
      passportInput.addEventListener('change', e=>{
        const file = e.target.files?.[0];
        if(!file) return;
        const url = URL.createObjectURL(file);
        cropImg.src = url;
        cropperWrap.classList.remove('hidden');

        if(cropper) cropper.destroy();
        cropper = new Cropper(cropImg, {
          viewMode:1, aspectRatio:3/4, autoCropArea:.9, background:false, movable:true, zoomable:true
        });
        [fitCrop, resetCrop, confirmCrop].forEach(b=>b.classList.remove('hidden'));
        cropConfirmed=false; confirmedPassportImg=null;
      });
    }
    fitCrop.onclick = ()=> cropper && cropper.reset();
    resetCrop.onclick = ()=> { if(!cropper) return; cropper.clear(); cropper.crop(); cropConfirmed=false; confirmedPassportImg=null; };
    confirmCrop.onclick = ()=> {
      if(!cropper){ showToast('Upload and crop first', 'warn'); return; }
      const cv = cropper.getCroppedCanvas({ width:600, height:800 });
      if(!cv){ showToast('No crop result', 'warn'); return; }
      cv.toBlob(blob=>{
        if(!blob){ showToast('Failed to get blob', 'warn'); return; }
        passportImageBlob = blob;
        const url = URL.createObjectURL(blob);
        const img = new Image();
        img.onload = ()=>{
          confirmedPassportImg = img;
          cropConfirmed = true;
          cropper.destroy(); cropper=null;
          cropperWrap.classList.add('hidden');
          [fitCrop, resetCrop, confirmCrop].forEach(b=>b.classList.add('hidden'));
          showToast('Crop confirmed. You can Generate now.');
        };
        img.src = url;
      }, 'image/png', 0.92);
    };

    /* ======= Canvas + drawSlip (NIN bold) ======= */
    const canvas = document.getElementById('preview');
    const ctx = canvas.getContext('2d');
    const bg = new Image(); bg.crossOrigin = "anonymous"; bg.src = "nin_bg.png";

    function formatDateDMY(dateStrOrDate){
      const d = new Date(dateStrOrDate); if(isNaN(d)) return "";
      const day = String(d.getDate()).padStart(2,"0");
      const months = ["JAN","FEB","MAR","APR","MAY","JUN","JUL","AUG","SEP","OCT","NOV","DEC"];
      return `${day} ${months[d.getMonth()]} ${d.getFullYear()}`;
    }

    function drawSlip(passportImg, data){
      return new Promise((resolve)=>{
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.drawImage(bg, 0, 0, canvas.width, canvas.height);

        ctx.fillStyle = "#000"; ctx.textBaseline = "top";
        const HEAD = "800 40px 'OCR B-10 BT', 'OCRB', monospace";
        const BIG  = "900 110px 'OCR B-10 BT', 'OCRB', monospace"; // heavier NIN

        ctx.font = HEAD;

        // Surname (secondName)
        ctx.fillText((data.secondName || "").toUpperCase(), 327, 230);

        // Given names (first + middle)
        ctx.fillText(((data.firstName || "") + (data.middleName ? ", " + data.middleName : "")).toUpperCase(), 327, 340);

        // DOB & Sex
        ctx.fillText(data.dobText || "", 327, 450);
        ctx.fillText(data.sexShort || "", 660, 450);

        // Issue date
        ctx.fillText(data.issueDate || "", 914, 520);

        // NIN big -> stroke + fill for bold
        ctx.font = BIG;
        const formattedNIN = (data.nin || "").replace(/(\d{4})(\d{3})(\d{4})/, "$1 $2 $3");
        ctx.lineWidth = Math.max(3, Math.round(canvas.width * 0.003));
        ctx.strokeStyle = 'rgba(0,0,0,0.18)';
        ctx.strokeText(formattedNIN, 160, canvas.height - 950);
        ctx.fillStyle = '#000';
        ctx.fillText(formattedNIN, 160, canvas.height - 950);

        // Passport image box
        if (passportImg) {
          const x = 36, y = 174, w = 264, h = 354;
          const ratio = Math.max(w/passportImg.width, h/passportImg.height);
          const pw = passportImg.width * ratio;
          const ph = passportImg.height * ratio;
          ctx.save(); ctx.beginPath(); ctx.rect(x, y, w, h); ctx.clip();
          ctx.drawImage(passportImg, x + (w-pw)/2, y + (h-ph)/2, pw, ph); ctx.restore();
        }

        if (data.qrData) {
          const qrCanvas = document.createElement("canvas");
          QRCode.toCanvas(qrCanvas, data.qrData, { width: 320 }, function () {
            ctx.drawImage(qrCanvas, canvas.width - 350, canvas.height - 1520);
            resolve();
          });
        } else {
          resolve();
        }
      });
    }

    /* ======= Demo watermark (maroon) ======= */
    function drawDemoWatermarks(){
      ctx.save();
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.globalCompositeOperation = 'source-over';
      const fillOpacity = 0.35;
      const strokeOpacity = 0.6;
      ctx.fillStyle = `rgba(128,0,0,${fillOpacity})`;
      ctx.strokeStyle = `rgba(128,0,0,${strokeOpacity})`;
      ctx.lineWidth = Math.max(2, Math.round(canvas.width * 0.0025));
      const fontSize = Math.round(canvas.width * 0.10);
      ctx.font = `900 ${fontSize}px 'Arial Black', 'Arial', sans-serif`;
      const positions = [
        {x: canvas.width*0.12, y: canvas.height*0.12, angle: -22},
        {x: canvas.width*0.42, y: canvas.height*0.16, angle: -16},
        {x: canvas.width*0.72, y: canvas.height*0.12, angle: -24},
        {x: canvas.width*0.22, y: canvas.height*0.44, angle: -18},
        {x: canvas.width*0.52, y: canvas.height*0.48, angle: -20},
        {x: canvas.width*0.82, y: canvas.height*0.46, angle: -18},
        {x: canvas.width*0.35, y: canvas.height*0.76, angle: -22},
        {x: canvas.width*0.65, y: canvas.height*0.80, angle: -18},
      ];
      positions.forEach(p=>{
        ctx.save();
        ctx.translate(p.x, p.y);
        ctx.rotate(p.angle * Math.PI / 180);
        ctx.fillText('PRE DEMO ONLY', 0, 0);
        ctx.strokeText('PRE DEMO ONLY', 0, 0);
        ctx.restore();
      });
      ctx.restore();
    }

    /* ======= Overlay / banner ======= */
    const previewWrap = document.getElementById('previewWrap');
    const previewBanner = document.getElementById('previewBanner');
    function ensurePreviewVisible(){ previewWrap.classList.remove('hidden'); previewWrap.scrollIntoView({behavior:'smooth', block:'start'}); }
    function overlayOn(){
      canvas.classList.add('processing-blur');
      if(!previewWrap.querySelector('.processing-overlay')){
        const ov=document.createElement('div');
        ov.className='processing-overlay';
        ov.innerHTML='<div class="spinner-mini" aria-label="Rendering"></div>';
        previewWrap.appendChild(ov);
      }
    }
    function overlayOff(){
      canvas.classList.remove('processing-blur');
      const ov=previewWrap.querySelector('.processing-overlay'); if(ov) ov.remove();
    }

    /* preview banner helper */
    function showPreviewBanner(msg, type='warn'){
      previewBanner.className = 'preview-banner ' + (type==='warn' ? 'warn' : 'info');
      previewBanner.innerHTML = `
        <div>${msg}</div>
        <div><a class="deposit-cta" href="deposit.html">Add Fund</a></div>
      `;
      previewBanner.classList.remove('hidden');
    }
    function clearPreviewBanner(){
      previewBanner.className = 'preview-banner hidden';
      previewBanner.innerHTML = '';
    }

    /* ======= Balance + gating with Firebase ======= */
    const printBtn = document.getElementById('downloadBtn');
    const pngBtn = document.getElementById('downloadPngBtn');
    let generatedOk = false;
    function disableOutputs(){ if(printBtn) printBtn.disabled = true; if(pngBtn) pngBtn.disabled = true; }
    function enableOutputs(){ if(printBtn) printBtn.disabled = false; if(pngBtn) pngBtn.disabled = false; }
    disableOutputs();

    const PROCESSING_MS = 15000; // 15s total
    const MIN_COST = 200;

    /* ======= Generate handler (DB transaction to deduct) with demoCount logic ======= */
    const msg3 = document.getElementById('msg3');

    async function incrementDemoCount(){
      const demoRef = ref(db, `users/${uid}/demoCount`);
      try{
        const tx = await runTransaction(demoRef, (c)=> ( (c||0) + 1 ), {applyLocally:false});
        const newCount = tx.snapshot && tx.snapshot.val() ? tx.snapshot.val() : (tx.committed ? tx.snapshot.val() : null);
        return Number(newCount || 0);
      }catch(e){
        console.error('Failed to increment demoCount', e);
        return null;
      }
    }

    function insertTransactionRecord(obj){
      // best-effort log
      const txRef = ref(db, `users/${uid}/transactions`);
      set(push(txRef), obj).catch(e=>console.error('log trx failed', e));
    }

    document.getElementById('generateBtn').addEventListener('click', async ()=>{
      msg3.classList.add('hidden'); msg3.textContent="";
      disableOutputs(); generatedOk = false;
      generateBtn.disabled = true;

      const firstName = document.getElementById('firstName').value.trim();
      const secondName = document.getElementById('secondName').value.trim();
      const middleName = document.getElementById('middleName').value.trim();
      const dob = document.getElementById('dob').value;
      const sex = document.getElementById('sex').value;
      const nin = document.getElementById('nin').value.trim();

      if(!firstName || !secondName || !dob || !sex || !/^[0-9]{11}$/.test(nin)){
        msg3.textContent = "Please complete all required fields correctly (NIN = 11 digits).";
        msg3.classList.remove('hidden'); generateBtn.disabled = false; return;
      }
      if(!cropConfirmed || !confirmedPassportImg){
        msg3.textContent = "Upload passport photo, crop, sannan danna OK kafin Generate.";
        msg3.classList.remove('hidden'); generateBtn.disabled = false; return;
      }

      ensurePreviewVisible();
      overlayOn();
      clearPreviewBanner();

      const dobText = formatDateDMY(dob);
      const issueDate = formatDateDMY(new Date());
      const sexShort = sex.toLowerCase()==='male' ? 'M' : (sex.toLowerCase()==='female' ? 'F' : sex);
      const givenNamesQR = firstName + (middleName ? ", " + middleName : "");
      const qrData = `Surname: ${secondName}
Given Names: ${givenNamesQR}
DOB: ${dobText}
NIN: ${nin}
Sex: ${sexShort}
Issue Date: ${issueDate}
Website: https://ameertech.netlify.app`;

      const start = performance.now();
      try{
        await drawSlip(confirmedPassportImg, { firstName, secondName, middleName, dobText, sexShort, issueDate, nin, qrData });
      }catch(e){
        console.error(e);
        overlayOff();
        showToast("Rendering failed.", 'warn');
        generateBtn.disabled = false;
        return;
      }

      const elapsed = performance.now() - start;
      const remain = Math.max(0, PROCESSING_MS - elapsed);
      if(remain>0) await new Promise(r=>setTimeout(r, remain));

      // Try atomic balance deduction
      try{
        const balanceRef = ref(db, `users/${uid}/balance`);
        const txResult = await runTransaction(balanceRef, (current)=>{
          if (current === null){ return current; }
          if (Number(current) >= MIN_COST) {
            return Number(current) - MIN_COST;
          }
          return;
        }, {applyLocally:false});

        if (txResult.committed && txResult.snapshot) {
          // Success: paid
          overlayOff();
          generatedOk = true;
          enableOutputs();
          clearPreviewBanner();
          showToast("Generated successfully. ‚Ç¶200 deducted. Preview ready.", 'info', 4000);

          // log success
          insertTransactionRecord({
            type: 'debit',
            action: 'generate',
            amount: MIN_COST,
            nin,
            firstName,
            secondName,
            timestamp: Date.now(),
            status: 'success'
          });
        } else {
          // Insufficient -> now apply demoCount rules
          // increment demoCount atomically
          const newDemoCount = await incrementDemoCount();
          // if unable to increment, assume conservative behaviour: lock preview
          if(newDemoCount === null){
            // fallback: lock preview (can't verify demo allowance)
            drawDemoWatermarks();
            overlayOff();
            generatedOk = false;
            disableOutputs();
            // lock view (strong blur + overlay)
            canvas.classList.add('locked-blur');
            // insert overlay element
            if(!previewWrap.querySelector('.locked-overlay')){
              const ov = document.createElement('div');
              ov.className = 'locked-overlay';
              ov.innerHTML = `<div style="text-align:center">
                <div style="font-weight:800;color:#b91c1c">Preview blocked</div>
                <div style="margin-top:6px;color:#374151">We couldn't verify demo allowance. Please add funds to continue.</div>
                <a class="deposit-cta" href="deposit.html">Add Fund</a>
              </div>`;
              previewWrap.appendChild(ov);
            }
            insertTransactionRecord({
              type: 'debit',
              action: 'generate',
              amount: 0,
              nin,
              firstName,
              secondName,
              timestamp: Date.now(),
              status: 'insufficient_unknown'
            });
            showPreviewBanner("Could not verify demo allowance. Add fund to remove block.");
            generateBtn.disabled = false;
            return;
          }

          // For first two demo uses: allow preview with watermark but disable outputs
          if(newDemoCount <= 2){
            drawDemoWatermarks();
            overlayOff();
            generatedOk = false;
            disableOutputs();
            // make sure preview is visible (no locked blur)
            canvas.classList.remove('locked-blur');
            const existingOv = previewWrap.querySelector('.locked-overlay');
            if(existingOv) existingOv.remove();
            showToast(`Demo preview (${newDemoCount}/2) ‚Äî watermark applied. Add fund to remove watermark.`, 'info', 6000);

            insertTransactionRecord({
              type: 'debit',
              action: 'generate',
              amount: 0,
              nin,
              firstName,
              secondName,
              timestamp: Date.now(),
              status: 'demo_shown',
              demoCount: newDemoCount
            });

            // show banner offering deposit but user can still view the watermarked preview
            showPreviewBanner(`Demo preview shown (${newDemoCount}/2) ‚Äî Add ‚Ç¶${MIN_COST} to remove watermark.`);
          } else {
            // demoCount > 2 => lock preview (blur & overlay) until deposit
            drawDemoWatermarks();
            overlayOff();
            generatedOk = false;
            disableOutputs();

            // lock view (strong blur + overlay)
            canvas.classList.add('locked-blur');
            if(!previewWrap.querySelector('.locked-overlay')){
              const ov = document.createElement('div');
              ov.className = 'locked-overlay';
              ov.innerHTML = `<div style="text-align:center">
                <div style="font-weight:800;color:#b91c1c">Preview blocked</div>
                <div style="margin-top:6px;color:#374151">You have used demo preview ${newDemoCount} times. Add ‚Ç¶${MIN_COST} to remove block and download.</div>
                <a class="deposit-cta" href="deposit.html">Add Fund</a>
              </div>`;
              previewWrap.appendChild(ov);
            }

            insertTransactionRecord({
              type: 'debit',
              action: 'generate',
              amount: 0,
              nin,
              firstName,
              secondName,
              timestamp: Date.now(),
              status: 'demo_blocked',
              demoCount: newDemoCount
            });

            showPreviewBanner(`Demo limit reached (${newDemoCount}). Add ‚Ç¶${MIN_COST} to remove block.`);
          }
        }
      }catch(err){
        console.error('Transaction error', err);
        overlayOff();
        generatedOk = false;
        disableOutputs();
        drawDemoWatermarks();

        insertTransactionRecord({
          type: 'debit',
          action: 'generate',
          amount: 0,
          nin,
          firstName,
          secondName,
          timestamp: Date.now(),
          status: 'error',
          errorMessage: String(err.message || err)
        });

        // fallback: lock preview (conservative)
        canvas.classList.add('locked-blur');
        if(!previewWrap.querySelector('.locked-overlay')){
          const ov = document.createElement('div');
          ov.className = 'locked-overlay';
          ov.innerHTML = `<div style="text-align:center">
            <div style="font-weight:800;color:#b91c1c">Preview blocked</div>
            <div style="margin-top:6px;color:#374151">Could not check/update balance. Add funds to continue.</div>
            <a class="deposit-cta" href="deposit.html">Add Fund</a>
          </div>`;
          previewWrap.appendChild(ov);
        }
        showPreviewBanner("Could not check/update balance (check connection/rules). Add fund to remove watermark.");
      } finally {
        generateBtn.disabled = false;
      }
    });

    /* ======= Print & Download ======= */
    document.getElementById('downloadBtn').addEventListener('click', ()=>{
      if(!generatedOk){ showToast("Generate successfully first or fund your wallet (‚Ç¶200).", 'warn'); return; }
      try{
        // remove any locked-blur before printing (shouldn't be possible when generatedOk true)
        canvas.classList.remove('locked-blur');
        const ov = previewWrap.querySelector('.locked-overlay'); if(ov) ov.remove();

        const dataUrl = canvas.toDataURL("image/png", 1.0);
        const iframe = document.createElement('iframe');
        iframe.style.position='fixed'; iframe.style.right='0'; iframe.style.bottom='0';
        iframe.style.width='0'; iframe.style.height='0'; iframe.style.border='0';
        document.body.appendChild(iframe);
        const doc = iframe.contentWindow.document;
        doc.open();
        doc.write(`
          <html><head><title>Print - NIN Slip</title>
            <style>
              @page { size: A4; margin: 10mm; }
              html,body{height:100%;width:100%;margin:0}
              .wrap{height:100%;width:100%;display:flex;align-items:center;justify-content:center}
              img{max-width:100%;max-height:100%;object-fit:contain}
            </style>
          </head>
          <body><div class="wrap"><img src="${dataUrl}" alt="NIN Slip"/></div></body></html>
        `);
        doc.close();
        iframe.onload = ()=>{ iframe.contentWindow.focus(); iframe.contentWindow.print(); setTimeout(()=>document.body.removeChild(iframe), 1000); };
      }catch(err){ showToast("Print failed: "+(err.message||err), 'warn'); }
    });
    document.getElementById('downloadPngBtn').addEventListener('click', ()=>{
      if(!generatedOk){ showToast("Generate successfully first or fund your wallet (‚Ç¶200).", 'warn'); return; }
      try{
        canvas.classList.remove('locked-blur');
        const ov = previewWrap.querySelector('.locked-overlay'); if(ov) ov.remove();

        const link = document.createElement('a');
        link.download='nin_slip.png';
        link.href = canvas.toDataURL('image/png', 1.0);
        link.click();
      }catch(err){ showToast("PNG download failed: "+(err.message||err), 'warn'); }
    });

    /* ======= T&C link ======= */
    const tcLink = document.getElementById('tcLink');
    if(tcLink) tcLink.addEventListener('click', (e)=>{
      e.preventDefault();
      showToast("By clicking Generate, you agree we deduct a non-refundable ‚Ç¶200 per generate. Use real information only. Fake info is not protected from disciplinary action.", 'warn', 7000);
    });

    // Init at step 1
    setStep(1);
  } // end main()
</script>
</body>
</html>